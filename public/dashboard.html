<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Dashboard - mOSm.Cloud</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #0f0f1a;
      --bg-card: #1a1a2e;
      --bg-card-hover: #252540;
      --accent: #00d4ff;
      --accent-secondary: #7c3aed;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.5);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(255, 255, 255, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      min-height: 100vh;
    }
    
    /* Sidebar */
    .sidebar {
      position: fixed;
      left: 0;
      top: 0;
      width: 260px;
      height: 100vh;
      background: var(--bg-card);
      border-right: 1px solid var(--border);
      padding: 20px 0;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-logo {
      padding: 0 20px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .sidebar-logo img {
      width: 36px;
      height: 36px;
      object-fit: contain;
    }
    
    .sidebar-logo h1 {
      font-size: 18px;
      font-weight: 600;
      margin: 0;
    }
    
    .sidebar-logo span {
      color: var(--accent);
    }
    
    .sidebar-nav {
      flex: 1;
      padding: 20px 0;
    }
    
    .nav-section {
      margin-bottom: 25px;
    }
    
    .nav-section-title {
      padding: 0 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: var(--text-muted);
      margin-bottom: 10px;
    }
    
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 20px;
      color: var(--text-secondary);
      text-decoration: none;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .nav-item:hover {
      background: var(--bg-card-hover);
      color: var(--text-primary);
    }
    
    .nav-item.active {
      background: rgba(0, 212, 255, 0.1);
      color: var(--accent);
      border-right: 3px solid var(--accent);
    }
    
    .nav-item svg {
      width: 20px;
      height: 20px;
    }
    
    .sidebar-footer {
      padding: 20px;
      border-top: 1px solid var(--border);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
    }
    
    .user-details {
      flex: 1;
    }
    
    .user-name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .user-role {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* Main Content */
    .main-content {
      margin-left: 260px;
      padding: 30px;
      min-height: 100vh;
    }
    
    /* Header */
    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
    }
    
    .page-title {
      font-size: 28px;
      font-weight: 700;
    }
    
    .page-subtitle {
      color: var(--text-secondary);
      margin-top: 5px;
    }
    
    .header-actions {
      display: flex;
      gap: 12px;
    }
    
    .btn {
      padding: 12px 20px;
      border-radius: 10px;
      border: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      transition: all 0.2s;
    }
    
    .btn-primary {
      background: linear-gradient(135deg, var(--accent) 0%, #0099cc 100%);
      color: white;
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.3);
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg-card-hover);
    }
    
    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--bg-card);
      border-radius: 16px;
      padding: 24px;
      border: 1px solid var(--border);
    }
    
    .stat-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 15px;
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .stat-icon.blue { background: rgba(0, 212, 255, 0.15); color: var(--accent); }
    .stat-icon.purple { background: rgba(124, 58, 237, 0.15); color: var(--accent-secondary); }
    .stat-icon.green { background: rgba(16, 185, 129, 0.15); color: var(--success); }
    .stat-icon.orange { background: rgba(245, 158, 11, 0.15); color: var(--warning); }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      color: var(--text-secondary);
      font-size: 14px;
    }
    
    .stat-change {
      font-size: 12px;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    
    .stat-change.positive { color: var(--success); }
    .stat-change.negative { color: var(--danger); }
    
    /* Content Grid */
    .content-grid {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 20px;
    }
    
    .card {
      background: var(--bg-card);
      border-radius: 16px;
      border: 1px solid var(--border);
      overflow: hidden;
    }
    
    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .card-title {
      font-size: 16px;
      font-weight: 600;
    }
    
    .card-body {
      padding: 24px;
    }
    
    /* Recent Menus List */
    .menu-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .menu-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 16px;
      background: var(--bg-dark);
      border-radius: 12px;
      transition: all 0.2s;
      cursor: pointer;
    }
    
    .menu-item:hover {
      background: var(--bg-card-hover);
    }
    
    .menu-thumb {
      width: 60px;
      height: 40px;
      background: linear-gradient(135deg, #2d2d44, #1a1a2e);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .menu-info {
      flex: 1;
    }
    
    .menu-name {
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .menu-meta {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .menu-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .menu-status.published {
      background: rgba(16, 185, 129, 0.15);
      color: var(--success);
    }
    
    .menu-status.draft {
      background: rgba(245, 158, 11, 0.15);
      color: var(--warning);
    }
    
    /* Device Status */
    .device-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    
    .device-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      background: var(--bg-dark);
      border-radius: 10px;
    }
    
    .device-status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }
    
    .device-status-dot.online {
      background: var(--success);
      box-shadow: 0 0 10px var(--success);
    }
    
    .device-status-dot.offline {
      background: var(--danger);
    }
    
    .device-info {
      flex: 1;
    }
    
    .device-name {
      font-size: 14px;
      font-weight: 500;
    }
    
    .device-location {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .device-screens {
      font-size: 12px;
      color: var(--text-secondary);
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }
    
    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .empty-state p {
      margin-bottom: 20px;
    }
    
    /* Alerts Banner */
    .alerts-banner {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 16px 20px;
      margin-bottom: 20px;
      display: none;
    }
    
    .alerts-banner.show {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .alerts-banner svg {
      color: var(--danger);
    }
    
    .alerts-banner span {
      color: var(--danger);
      font-weight: 500;
    }
    
    /* Loading State */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
    }
    
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .content-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <img src="/images/modOSlogo.png" alt="mOSm.Cloud">
      <h1>m<span>OSm</span>.Cloud</h1>
    </div>
    
    <nav class="sidebar-nav">
      <div class="nav-section">
        <div class="nav-section-title">Main</div>
        <a href="/dashboard.html" class="nav-item active">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
          </svg>
          Dashboard
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Content</div>
        <a href="/menus.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
          </svg>
          Menus
        </a>
        <a href="/layouts.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" />
          </svg>
          Layouts
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Devices</div>
        <a href="/screens.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
          </svg>
          Screens
        </a>
        <a href="/devices.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
          </svg>
          Devices
        </a>
      </div>
      
      <div class="nav-section">
        <div class="nav-section-title">Admin</div>
        <a href="/users.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" />
          </svg>
          Users
        </a>
        <a href="/settings.html" class="nav-item">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
          </svg>
          Settings
        </a>
      </div>
    </nav>
    
    <div class="sidebar-footer">
      <div class="user-info">
        <div class="user-avatar" id="userAvatar">?</div>
        <div class="user-details">
          <div class="user-name" id="userName">Loading...</div>
          <div class="user-role" id="userRole">-</div>
        </div>
        <button onclick="logout()" style="background: none; border: none; cursor: pointer; color: var(--text-muted);">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
          </svg>
        </button>
      </div>
    </div>
  </aside>
  
  <!-- Main Content -->
  <main class="main-content">
    <div class="page-header">
      <div>
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Overview of your digital menu system</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-secondary" onclick="refreshData()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
          </svg>
          Refresh
        </button>
        <button class="btn btn-primary" onclick="createNewMenu()">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
          </svg>
          New Menu
        </button>
      </div>
    </div>
    
    <!-- Alerts Banner -->
    <div class="alerts-banner" id="alertsBanner">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
      </svg>
      <span id="alertsText">1 device offline</span>
    </div>
    
    <!-- Stats Grid -->
    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon blue">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
            </svg>
          </div>
        </div>
        <div class="stat-value" id="totalMenus">0</div>
        <div class="stat-label">Total Menus</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon purple">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
            </svg>
          </div>
        </div>
        <div class="stat-value" id="totalScreens">0</div>
        <div class="stat-label">Total Screens</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon green">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
            </svg>
          </div>
        </div>
        <div class="stat-value" id="onlineDevices">0</div>
        <div class="stat-label">Devices Online</div>
      </div>
      
      <div class="stat-card">
        <div class="stat-header">
          <div class="stat-icon orange">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
          </div>
        </div>
        <div class="stat-value" id="lastUpdate">-</div>
        <div class="stat-label">Last Update</div>
      </div>
    </div>
    
    <!-- Content Grid -->
    <div class="content-grid">
      <!-- Recent Menus -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Recent Menus</h3>
          <a href="/admin.html#menus" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">View All</a>
        </div>
        <div class="card-body">
          <div class="menu-list" id="menuList">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Device Status -->
      <div class="card">
        <div class="card-header">
          <h3 class="card-title">Device Status</h3>
          <a href="/admin.html#devices" class="btn btn-secondary" style="padding: 8px 16px; font-size: 13px;">Manage</a>
        </div>
        <div class="card-body">
          <div class="device-list" id="deviceList">
            <div class="loading">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>
  
  <script>
    const API_BASE = '/api';
    let currentUser = null;
    let currentSession = null;
    let currentOrganization = null;

    // Check authentication and organization
    async function checkAuth() {
      // Check for token passed via URL (cross-domain auth from modOSmenus)
      const urlParams = new URLSearchParams(window.location.search);
      const tokenFromUrl = urlParams.get('token');
      
      if (tokenFromUrl) {
        // Verify and establish session from URL token
        try {
          const response = await fetch('/api/auth/session', {
            headers: {
              'Authorization': `Bearer ${tokenFromUrl}`
            }
          });
          
          if (response.ok) {
            const data = await response.json();
            // Create session object and store
            const session = { access_token: tokenFromUrl };
            localStorage.setItem('mosm_session', JSON.stringify(session));
            localStorage.setItem('mosm_user', JSON.stringify(data.user));
            
            // Clean URL to remove token
            window.history.replaceState({}, document.title, window.location.pathname);
          }
        } catch (e) {
          console.log('Token verification failed:', e);
        }
      }
      
      const sessionStr = localStorage.getItem('mosm_session');
      const userStr = localStorage.getItem('mosm_user');
      
      if (!sessionStr || !userStr) {
        window.location.href = '/login.html';
        return false;
      }
      
      currentSession = JSON.parse(sessionStr);
      currentUser = JSON.parse(userStr);
      
      // Check if user has an organization
      try {
        const response = await fetch('/api/organizations', {
          headers: {
            'Authorization': `Bearer ${currentSession.access_token}`
          }
        });
        const orgData = await response.json();
        
        console.log('Organization check:', orgData); // Debug
        
        if (orgData.requiresOnboarding) {
          console.log('Redirecting to onboarding...');
          window.location.href = '/onboarding.html';
          return false;
        }
        
        currentOrganization = orgData.organization;
        localStorage.setItem('mosm_organization', JSON.stringify(currentOrganization));
      } catch (error) {
        console.error('Error checking organization:', error);
        // If org check fails, redirect to onboarding to be safe
        window.location.href = '/onboarding.html';
        return false;
      }
      
      // Update user info in sidebar
      const initials = (currentUser.user_metadata?.name || currentUser.email || '?')
        .split(' ')
        .map(n => n[0])
        .join('')
        .toUpperCase()
        .slice(0, 2);
      
      document.getElementById('userAvatar').textContent = initials;
      document.getElementById('userName').textContent = currentUser.user_metadata?.name || currentUser.email;
      document.getElementById('userRole').textContent = currentOrganization?.name || 'User';
      
      return true;
    }
    
    // Logout
    function logout() {
      localStorage.removeItem('mosm_session');
      localStorage.removeItem('mosm_user');
      window.location.href = '/login.html';
    }
    
    // API request helper
    async function apiRequest(endpoint, options = {}) {
      const headers = {
        'Content-Type': 'application/json',
        ...options.headers
      };
      
      if (currentSession?.access_token) {
        headers['Authorization'] = `Bearer ${currentSession.access_token}`;
      }
      
      const response = await fetch(`${API_BASE}${endpoint}`, {
        ...options,
        headers
      });
      
      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Request failed');
      }
      
      return response.json();
    }
    
    // Load dashboard data
    async function loadDashboard() {
      try {
        // Load menus
        const menusData = await apiRequest('/menus');
        const menus = menusData.menus || [];
        
        document.getElementById('totalMenus').textContent = menus.length;
        
        // Render recent menus
        const menuList = document.getElementById('menuList');
        if (menus.length === 0) {
          menuList.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
              </svg>
              <p>No menus yet</p>
              <button class="btn btn-primary" onclick="createNewMenu()">Create your first menu</button>
            </div>
          `;
        } else {
          menuList.innerHTML = menus.slice(0, 5).map(menu => `
            <div class="menu-item" onclick="editMenu('${menu.id}')">
              <div class="menu-thumb">MENU</div>
              <div class="menu-info">
                <div class="menu-name">${menu.name}</div>
                <div class="menu-meta">v${menu.version} â€¢ Updated ${formatDate(menu.updated_at)}</div>
              </div>
              <span class="menu-status ${menu.status}">${menu.status}</span>
            </div>
          `).join('');
        }
        
        // Load devices
        const devicesData = await apiRequest('/devices');
        const devices = devicesData.devices || [];
        
        const onlineCount = devices.filter(d => d.status === 'online').length;
        const offlineCount = devices.filter(d => d.status === 'offline').length;
        const totalScreens = devices.reduce((acc, d) => acc + (d.screens?.length || 0), 0);
        
        document.getElementById('totalScreens').textContent = totalScreens;
        document.getElementById('onlineDevices').textContent = `${onlineCount}/${devices.length}`;
        
        // Show alerts if devices offline
        if (offlineCount > 0) {
          document.getElementById('alertsBanner').classList.add('show');
          document.getElementById('alertsText').textContent = `${offlineCount} device${offlineCount > 1 ? 's' : ''} offline`;
        }
        
        // Render device list
        const deviceList = document.getElementById('deviceList');
        if (devices.length === 0) {
          deviceList.innerHTML = `
            <div class="empty-state">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14M5 12a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v4a2 2 0 01-2 2M5 12a2 2 0 00-2 2v4a2 2 0 002 2h14a2 2 0 002-2v-4a2 2 0 00-2-2" />
              </svg>
              <p>No devices registered</p>
            </div>
          `;
        } else {
          deviceList.innerHTML = devices.map(device => `
            <div class="device-item">
              <div class="device-status-dot ${device.status}"></div>
              <div class="device-info">
                <div class="device-name">${device.name}</div>
                <div class="device-location">${device.location || 'No location set'}</div>
              </div>
              <div class="device-screens">${device.screens?.length || 0} screens</div>
            </div>
          `).join('');
        }
        
        // Update last update time
        document.getElementById('lastUpdate').textContent = formatTime(new Date());
        
      } catch (error) {
        console.error('Error loading dashboard:', error);
      }
    }
    
    // Format date
    function formatDate(dateStr) {
      const date = new Date(dateStr);
      const now = new Date();
      const diff = now - date;
      
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return `${Math.floor(diff / 60000)}m ago`;
      if (diff < 86400000) return `${Math.floor(diff / 3600000)}h ago`;
      if (diff < 604800000) return `${Math.floor(diff / 86400000)}d ago`;
      
      return date.toLocaleDateString();
    }
    
    // Format time
    function formatTime(date) {
      return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }
    
    // Refresh data
    function refreshData() {
      loadDashboard();
    }
    
    // Create new menu
    async function createNewMenu() {
      const name = prompt('Enter menu name:');
      if (!name) return;
      
      try {
        const result = await apiRequest('/menus', {
          method: 'POST',
          body: JSON.stringify({ name })
        });
        
        // Redirect to edit the new menu
        window.location.href = `/admin.html#menus/${result.menu.id}`;
      } catch (error) {
        alert('Error creating menu: ' + error.message);
      }
    }
    
    // Edit menu
    function editMenu(menuId) {
      window.location.href = `/admin.html#menus/${menuId}`;
    }
    
    // Initialize - wait for auth check before loading dashboard
    async function init() {
      const isAuthorized = await checkAuth();
      // Only load dashboard if we didn't redirect
      if (isAuthorized) {
        loadDashboard();
        // Auto-refresh every 30 seconds
        setInterval(loadDashboard, 30000);
      }
    }
    
    init();
  </script>
</body>
</html>
