<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Menu Editor - mOSm.Cloud</title>
  <!-- Supabase JS for direct auth -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- Shared Auth Module -->
  <script src="/js/auth.js?v=1766969346"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    :root {
      --bg-dark: #0a0a0f;
      --bg-panel: #12121a;
      --bg-card: #1a1a2e;
      --bg-hover: #252540;
      --accent: #00d4ff;
      --accent-secondary: #7c3aed;
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.7);
      --text-muted: rgba(255, 255, 255, 0.5);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --border: rgba(255, 255, 255, 0.1);
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: var(--bg-dark);
      color: var(--text-primary);
      height: 100vh;
      overflow: hidden;
    }
    
    /* Top Bar */
    .top-bar {
      height: 50px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
    }
    
    .top-bar-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }
    
    .back-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      text-decoration: none;
      font-size: 14px;
      padding: 6px 12px;
      border-radius: 6px;
      transition: all 0.2s;
    }
    
    .back-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .menu-name {
      font-size: 16px;
      font-weight: 600;
    }
    
    .menu-status {
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 12px;
      background: rgba(255, 193, 7, 0.2);
      color: #ffc107;
    }
    
    .menu-status.published {
      background: rgba(16, 185, 129, 0.2);
      color: var(--success);
    }
    
    .top-bar-center {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 4px;
      background: var(--bg-card);
      padding: 4px;
      border-radius: 6px;
    }
    
    .zoom-btn {
      width: 28px;
      height: 28px;
      border: none;
      background: transparent;
      color: var(--text-secondary);
      cursor: pointer;
      border-radius: 4px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    
    .zoom-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .zoom-value {
      font-size: 12px;
      color: var(--text-secondary);
      min-width: 40px;
      text-align: center;
    }
    
    .top-bar-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .btn {
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .btn-secondary {
      background: var(--bg-card);
      color: var(--text-primary);
      border: 1px solid var(--border);
    }
    
    .btn-secondary:hover {
      background: var(--bg-hover);
    }
    
    .btn-primary {
      background: linear-gradient(135deg, #00d4ff 0%, #0099cc 100%);
      color: #fff;
    }
    
    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3);
    }
    
    .btn-success {
      background: linear-gradient(135deg, var(--success) 0%, #059669 100%);
      color: #fff;
    }
    
    .btn-icon {
      padding: 8px;
      min-width: 36px;
    }
    
    .btn-icon:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .history-controls {
      display: flex;
      gap: 4px;
      margin-right: 16px;
      padding-right: 16px;
      border-right: 1px solid var(--border);
    }
    
    /* Collapsible Panels */
    .panel-header-collapsible {
      cursor: pointer;
      user-select: none;
    }
    
    .panel-header-collapsible:hover {
      background: var(--bg-hover);
    }
    
    .collapse-icon {
      transition: transform 0.2s;
      font-size: 10px;
      color: var(--text-muted);
    }
    
    .collapsed .collapse-icon {
      transform: rotate(-90deg);
    }
    
    .panel-content {
      overflow: hidden;
      transition: max-height 0.3s ease;
    }
    
    .collapsed .panel-content {
      max-height: 0 !important;
      padding: 0 !important;
    }
    
    .property-section.collapsible {
      padding: 0;
    }
    
    .property-section.collapsible .panel-header-collapsible {
      padding: 12px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .property-section.collapsible .panel-content {
      padding: 0 16px 16px 16px;
    }
    
    .property-section.collapsible.collapsed .panel-content {
      padding: 0;
    }
    
    /* Scrollable right panel */
    .properties-panel {
      overflow-y: auto;
    }
    
    /* Main Layout */
    .editor-layout {
      display: flex;
      height: calc(100vh - 50px);
    }
    
    /* Left Panel - Screens List */
    .screens-panel {
      width: 240px;
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .panel-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }
    
    .add-screen-btn {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }
    
    .add-screen-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .screens-list {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .screen-card {
      background: var(--bg-card);
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 8px;
      cursor: pointer;
      border: 2px solid transparent;
      transition: all 0.2s;
      position: relative;
    }
    
    .screen-card:hover {
      background: var(--bg-hover);
    }
    
    .screen-card.active {
      border-color: var(--accent);
      background: rgba(0, 212, 255, 0.1);
    }
    
    .screen-card.dragging {
      opacity: 0.5;
      border-color: var(--accent);
    }
    
    .screen-card.drag-over {
      border-top: 2px solid var(--accent);
    }
    
    .screen-card-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
    }
    
    .screen-drag-handle {
      cursor: grab;
      color: var(--text-muted);
      padding: 2px;
      opacity: 0.5;
      transition: opacity 0.2s;
    }
    
    .screen-drag-handle:hover {
      opacity: 1;
    }
    
    .screen-drag-handle:active {
      cursor: grabbing;
    }
    
    .screen-card-actions {
      position: absolute;
      top: 8px;
      right: 8px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .screen-card:hover .screen-card-actions {
      opacity: 1;
    }
    
    .screen-action-btn {
      width: 24px;
      height: 24px;
      border-radius: 4px;
      border: none;
      background: var(--bg-dark);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
    }
    
    .screen-action-btn:hover {
      background: var(--danger);
      color: white;
    }
    
    .screen-preview {
      background: #000;
      border-radius: 4px;
      aspect-ratio: 16/9;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--text-muted);
      overflow: hidden;
      position: relative;
    }
    
    .screen-preview.portrait {
      aspect-ratio: 9/16;
      max-height: 120px;
    }
    
    .screen-name {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .screen-resolution {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* Canvas Area */
    .canvas-area {
      flex: 1;
      background: var(--bg-dark);
      overflow: hidden;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .canvas-wrapper {
      position: relative;
      transition: transform 0.1s ease-out;
    }
    
    .canvas-container {
      background: #000;
      box-shadow: 0 0 60px rgba(0, 0, 0, 0.5);
      position: relative;
      overflow: hidden;
    }
    
    .safe-zone-overlay {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      pointer-events: none;
      border: 2px dashed rgba(255, 193, 7, 0.3);
      z-index: 100;
    }
    
    .canvas-content {
      width: 100%;
      height: 100%;
      position: relative;
    }
    
    /* Element on canvas */
    .canvas-element {
      position: absolute;
      cursor: move;
      user-select: none;
    }
    
    .canvas-element.selected {
      outline: 2px solid var(--accent);
      outline-offset: 2px;
    }
    
    /* Resize handles */
    .resize-handle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: var(--accent);
      border: 2px solid #fff;
      border-radius: 2px;
      z-index: 100;
    }
    
    .resize-handle.nw { top: -5px; left: -5px; cursor: nw-resize; }
    .resize-handle.n { top: -5px; left: 50%; transform: translateX(-50%); cursor: n-resize; }
    .resize-handle.ne { top: -5px; right: -5px; cursor: ne-resize; }
    .resize-handle.e { top: 50%; right: -5px; transform: translateY(-50%); cursor: e-resize; }
    .resize-handle.se { bottom: -5px; right: -5px; cursor: se-resize; }
    .resize-handle.s { bottom: -5px; left: 50%; transform: translateX(-50%); cursor: s-resize; }
    .resize-handle.sw { bottom: -5px; left: -5px; cursor: sw-resize; }
    .resize-handle.w { top: 50%; left: -5px; transform: translateY(-50%); cursor: w-resize; }
    
    .element-text {
      color: #fff;
      padding: 8px;
    }
    
    .element-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    
    .element-shape {
      width: 100%;
      height: 100%;
    }
    
    /* Right Panel - Properties */
    .properties-panel {
      width: 280px;
      background: var(--bg-panel);
      border-left: 1px solid var(--border);
      display: flex;
      flex-direction: column;
    }
    
    .property-section {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .property-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .property-row {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .property-label {
      font-size: 12px;
      color: var(--text-secondary);
      width: 70px;
      flex-shrink: 0;
    }
    
    .property-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text-primary);
      font-size: 13px;
    }
    
    .property-input:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .property-input-small {
      width: 60px;
    }
    
    .property-input-group {
      display: flex;
      gap: 8px;
      flex: 1;
    }
    
    .property-input-group input {
      flex: 1;
      min-width: 0;
    }
    
    select.property-input {
      cursor: pointer;
    }
    
    /* Toolbar */
    .toolbar {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }
    
    .toolbar-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
      margin-bottom: 12px;
    }
    
    .tool-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 6px;
    }
    
    .tool-btn {
      aspect-ratio: 1;
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 4px;
      color: var(--text-secondary);
      transition: all 0.2s;
      padding: 8px;
    }
    
    .tool-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--accent);
    }
    
    .tool-btn svg {
      width: 20px;
      height: 20px;
    }
    
    .tool-btn span {
      font-size: 9px;
    }

    /* Menu Components Section */
    .tool-section-divider {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin: 12px 0 8px 0;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .menu-tool-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 6px;
    }

    .menu-tool-btn {
      border: 1px solid var(--border);
      background: var(--bg-card);
      border-radius: 8px;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      transition: all 0.2s;
      padding: 10px;
      text-align: left;
    }

    .menu-tool-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent-secondary);
      color: var(--accent-secondary);
    }

    .menu-tool-btn .icon {
      font-size: 16px;
      width: 20px;
      text-align: center;
    }

    .menu-tool-btn .label {
      font-size: 11px;
      font-weight: 500;
    }

    /* Menu Element Styles on Canvas */
    .menu-item-element {
      background: rgba(0, 0, 0, 0.6);
      border-radius: 8px;
      padding: 12px;
      display: flex;
      gap: 12px;
    }

    .menu-item-element .item-image {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      flex-shrink: 0;
      object-fit: cover;
    }

    .menu-item-element .item-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    .menu-item-element .item-name {
      font-size: 24px;
      font-weight: 600;
      color: #fff;
      margin-bottom: 4px;
    }

    .menu-item-element .item-description {
      font-size: 14px;
      color: rgba(255,255,255,0.7);
      margin-bottom: 8px;
      line-height: 1.4;
    }

    .menu-item-element .item-price {
      font-size: 22px;
      font-weight: 700;
      color: #00d4ff;
    }

    .menu-section-element {
      padding: 16px;
    }

    .menu-section-element .section-title {
      font-size: 36px;
      font-weight: 700;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 2px;
      margin-bottom: 8px;
    }

    .menu-section-element .section-divider {
      height: 3px;
      background: linear-gradient(90deg, #00d4ff 0%, transparent 100%);
      border-radius: 2px;
    }

    .price-list-element {
      background: rgba(0, 0, 0, 0.5);
      border-radius: 8px;
      padding: 16px;
    }

    .price-list-element .price-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px dotted rgba(255,255,255,0.2);
    }

    .price-list-element .price-row:last-child {
      border-bottom: none;
    }

    .price-list-element .price-name {
      font-size: 18px;
      color: #fff;
    }

    .price-list-element .price-value {
      font-size: 18px;
      font-weight: 600;
      color: #00d4ff;
    }

    .combo-element {
      background: linear-gradient(135deg, rgba(124, 58, 237, 0.3) 0%, rgba(0, 212, 255, 0.2) 100%);
      border: 2px solid rgba(124, 58, 237, 0.5);
      border-radius: 12px;
      padding: 16px;
      position: relative;
    }

    .combo-element .combo-badge {
      position: absolute;
      top: -10px;
      right: 16px;
      background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);
      color: #fff;
      font-size: 12px;
      font-weight: 700;
      padding: 4px 12px;
      border-radius: 12px;
      text-transform: uppercase;
    }

    .combo-element .combo-title {
      font-size: 28px;
      font-weight: 700;
      color: #fff;
      margin-bottom: 8px;
    }

    .combo-element .combo-items {
      font-size: 14px;
      color: rgba(255,255,255,0.8);
      margin-bottom: 12px;
    }

    .combo-element .combo-price {
      font-size: 32px;
      font-weight: 800;
      color: #00d4ff;
    }

    .category-header-element {
      text-align: center;
      padding: 20px;
    }

    .category-header-element .category-icon {
      font-size: 48px;
      margin-bottom: 8px;
    }

    .category-header-element .category-title {
      font-size: 42px;
      font-weight: 800;
      color: #fff;
      text-transform: uppercase;
      letter-spacing: 3px;
    }

    .category-header-element .category-subtitle {
      font-size: 16px;
      color: rgba(255,255,255,0.6);
      margin-top: 8px;
    }

    .ticker-element {
      background: rgba(0, 0, 0, 0.8);
      padding: 12px 20px;
      overflow: hidden;
      white-space: nowrap;
    }

    .ticker-element .ticker-content {
      display: inline-block;
      animation: ticker-scroll 20s linear infinite;
      font-size: 18px;
      color: #fff;
    }

    @keyframes ticker-scroll {
      0% { transform: translateX(100%); }
      100% { transform: translateX(-100%); }
    }

    /* Contextual Properties Panels */
    .menu-item-props, .menu-section-props, .price-list-props, .combo-props, .category-props, .ticker-props {
      display: none;
    }

    .property-textarea {
      width: 100%;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 10px;
      color: var(--text-primary);
      font-size: 13px;
      font-family: inherit;
      resize: vertical;
      min-height: 60px;
    }

    .property-textarea:focus {
      outline: none;
      border-color: var(--accent);
    }

    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .toggle-switch {
      width: 40px;
      height: 22px;
      background: var(--bg-card);
      border-radius: 11px;
      position: relative;
      cursor: pointer;
      transition: background 0.2s;
    }

    .toggle-switch.active {
      background: var(--accent);
    }

    .toggle-switch::after {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 18px;
      height: 18px;
      background: #fff;
      border-radius: 50%;
      transition: transform 0.2s;
    }

    .toggle-switch.active::after {
      transform: translateX(18px);
    }

    /* Template Modal */
    .template-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      max-height: 400px;
      overflow-y: auto;
    }

    .template-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .template-card:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }

    .template-card.selected {
      border-color: var(--accent);
      background: rgba(0, 212, 255, 0.1);
    }

    .template-preview {
      background: #000;
      border-radius: 6px;
      aspect-ratio: 16/9;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
    }

    .template-name {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
    }

    .template-desc {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* Auto-layout toolbar */
    .layout-toolbar {
      display: flex;
      gap: 4px;
      margin-top: 8px;
    }

    .layout-btn {
      flex: 1;
      padding: 6px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
    }

    .layout-btn:hover {
      background: var(--bg-hover);
      color: var(--accent);
    }
    
    /* Layers */
    .layers-panel {
      flex: 1;
      overflow-y: auto;
      padding: 12px;
    }
    
    .layer-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--bg-card);
      border-radius: 6px;
      margin-bottom: 4px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.15s ease;
      border: 1px solid transparent;
    }
    
    .layer-item:hover {
      background: var(--bg-hover);
    }
    
    .layer-item.selected {
      background: rgba(0, 212, 255, 0.1);
      border: 1px solid var(--accent);
    }
    
    .layer-item.hidden {
      opacity: 0.4;
    }
    
    .layer-item.locked {
      background: rgba(255, 200, 0, 0.05);
    }
    
    .layer-item.dragging {
      opacity: 0.5;
      background: var(--accent);
    }
    
    .layer-item.drag-over {
      border: 2px dashed var(--accent);
    }
    
    .layer-drag-handle {
      cursor: grab;
      opacity: 0.3;
      font-size: 10px;
      user-select: none;
    }
    
    .layer-drag-handle:hover {
      opacity: 0.8;
    }
    
    .layer-icon {
      width: 16px;
      height: 16px;
      color: var(--text-muted);
      font-size: 12px;
      text-align: center;
    }
    
    .layer-name {
      flex: 1;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .layer-name-input {
      flex: 1;
      background: var(--bg-input);
      border: 1px solid var(--accent);
      color: var(--text-primary);
      padding: 2px 6px;
      border-radius: 3px;
      font-size: 12px;
      outline: none;
    }
    
    .layer-actions {
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.15s;
    }
    
    .layer-item:hover .layer-actions {
      opacity: 1;
    }
    
    .layer-action-btn {
      width: 20px;
      height: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      border-radius: 3px;
      font-size: 11px;
      padding: 0;
    }
    
    .layer-action-btn:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }
    
    .layer-action-btn.active {
      color: var(--accent);
    }
    
    .layer-action-btn.locked-active {
      color: #ffcc00;
    }
    
    .layer-visibility {
      opacity: 0.5;
      cursor: pointer;
      font-size: 12px;
    }
    
    .layer-visibility:hover {
      opacity: 1;
    }
    
    .layer-visibility.hidden {
      opacity: 0.3;
    }
    
    /* Layer groups / nesting */
    .layer-item.nested {
      margin-left: 20px;
      border-left: 2px solid var(--bg-hover);
    }
    
    .layer-group-toggle {
      cursor: pointer;
      font-size: 10px;
      transition: transform 0.15s;
    }
    
    .layer-group-toggle.collapsed {
      transform: rotate(-90deg);
    }
    
    /* Property Tabs */
    .property-tabs {
      display: flex;
      border-bottom: 1px solid var(--border);
      margin-bottom: 12px;
    }
    
    .property-tab {
      flex: 1;
      padding: 10px 12px;
      background: none;
      border: none;
      color: var(--text-muted);
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.15s;
      border-bottom: 2px solid transparent;
      text-align: center;
    }
    
    .property-tab:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }
    
    .property-tab.active {
      color: var(--accent);
      border-bottom-color: var(--accent);
    }
    
    .property-tab-content {
      display: none;
    }
    
    .property-tab-content.active {
      display: block;
    }
    
    /* Group element styling */
    .element-group {
      border: 2px dashed rgba(0, 212, 255, 0.3);
      background: rgba(0, 212, 255, 0.05);
      border-radius: 8px;
    }
    
    .element-group.selected {
      border: 2px solid var(--accent);
      box-shadow: 0 0 20px rgba(0, 212, 255, 0.2);
    }
    
    .group-label {
      position: absolute;
      top: -20px;
      left: 8px;
      font-size: 10px;
      color: var(--accent);
      background: var(--bg-panel);
      padding: 2px 6px;
      border-radius: 4px;
    }
    
    /* Nesting indicator */
    .nesting-toolbar {
      display: flex;
      gap: 8px;
      padding: 8px 0;
      border-top: 1px solid var(--border);
      margin-top: 8px;
    }
    
    .nesting-btn {
      flex: 1;
      padding: 8px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-secondary);
      font-size: 11px;
      cursor: pointer;
      transition: all 0.15s;
    }
    
    .nesting-btn:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    
    /* Modal */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      display: none;
    }
    
    .modal-overlay.show {
      display: flex;
    }
    
    .modal {
      background: var(--bg-panel);
      border-radius: 12px;
      padding: 24px;
      width: 100%;
      max-width: 500px;
      border: 1px solid var(--border);
    }
    
    .modal-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    
    .modal-title {
      font-size: 18px;
      font-weight: 600;
    }
    
    .modal-close {
      background: none;
      border: none;
      color: var(--text-muted);
      cursor: pointer;
      font-size: 24px;
    }
    
    .modal-body {
      margin-bottom: 24px;
    }
    
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }
    
    .resolution-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
      max-height: 300px;
      overflow-y: auto;
    }
    
    .resolution-option {
      padding: 12px;
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .resolution-option:hover {
      background: var(--bg-hover);
      border-color: var(--accent);
    }
    
    .resolution-option.selected {
      border-color: var(--accent);
      background: rgba(0, 212, 255, 0.1);
    }
    
    .resolution-option-name {
      font-size: 13px;
      font-weight: 500;
      margin-bottom: 4px;
    }
    
    .resolution-option-size {
      font-size: 11px;
      color: var(--text-muted);
    }
    
    /* No screens state */
    .no-screens {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
      text-align: center;
      padding: 40px;
    }
    
    .no-screens svg {
      width: 48px;
      height: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
    
    .no-screens p {
      margin-bottom: 16px;
    }

    /* Canvas resolution info */
    .canvas-info {
      position: absolute;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.8);
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 12px;
      color: var(--text-secondary);
    }

    /* Loading state */
    .loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">
    <div class="top-bar-left">
      <a href="/dashboard.html" class="back-btn">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M15 18l-6-6 6-6"/>
        </svg>
        Dashboard
      </a>
      <span class="menu-name" id="menuName">Loading...</span>
      <span class="menu-status" id="menuStatus">draft</span>
    </div>
    
    <div class="top-bar-center">
      <div class="history-controls">
        <button class="btn btn-secondary btn-icon" id="undoBtn" onclick="undo()" title="Undo (Ctrl+Z)" disabled>
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M3 10h10a5 5 0 0 1 5 5v2M3 10l4-4M3 10l4 4"/>
          </svg>
        </button>
        <button class="btn btn-secondary btn-icon" id="redoBtn" onclick="redo()" title="Redo (Ctrl+Shift+Z)" disabled>
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <path d="M21 10H11a5 5 0 0 0-5 5v2M21 10l-4-4M21 10l-4 4"/>
          </svg>
        </button>
      </div>
      <div class="zoom-controls">
        <button class="zoom-btn" onclick="zoomOut()" title="Zoom Out">‚àí</button>
        <span class="zoom-value" id="zoomValue">100%</span>
        <button class="zoom-btn" onclick="zoomIn()" title="Zoom In">+</button>
        <button class="zoom-btn" onclick="zoomFit()" title="Fit to View">‚ä°</button>
      </div>
    </div>
    
    <div class="top-bar-right">
      <button class="btn btn-secondary" onclick="saveLayout()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/>
          <polyline points="17 21 17 13 7 13 7 21"/>
          <polyline points="7 3 7 8 15 8"/>
        </svg>
        Save
      </button>
      <button class="btn btn-success" onclick="publishMenu()">
        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
          <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z"/>
        </svg>
        Publish
      </button>
    </div>
  </div>
  
  <!-- Main Editor Layout -->
  <div class="editor-layout">
    <!-- Left Panel: Screens/Layouts -->
    <div class="screens-panel">
      <div class="panel-header">
        <span class="panel-title">Screens</span>
        <button class="add-screen-btn" onclick="showAddScreenModal()" title="Add Screen">+</button>
      </div>
      <div class="screens-list" id="screensList">
        <!-- Screens rendered here -->
      </div>
    </div>
    
    <!-- Canvas Area -->
    <div class="canvas-area" id="canvasArea">
      <div class="no-screens" id="noScreensMessage">
        <svg fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" d="M9 17.25v1.007a3 3 0 01-.879 2.122L7.5 21h9l-.621-.621A3 3 0 0115 18.257V17.25m6-12V15a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 15V5.25m18 0A2.25 2.25 0 0018.75 3H5.25A2.25 2.25 0 003 5.25m18 0V12a2.25 2.25 0 01-2.25 2.25H5.25A2.25 2.25 0 013 12V5.25"/>
        </svg>
        <p>No screens in this menu yet</p>
        <button class="btn btn-primary" onclick="showAddScreenModal()">Add First Screen</button>
      </div>
      
      <div class="canvas-wrapper" id="canvasWrapper" style="display: none;">
        <div class="canvas-container" id="canvasContainer">
          <div class="safe-zone-overlay" id="safeZoneOverlay"></div>
          <div class="canvas-content" id="canvasContent">
            <!-- Elements rendered here -->
          </div>
        </div>
      </div>
      
      <div class="canvas-info" id="canvasInfo" style="display: none;">
        <span id="resolutionInfo">1920 √ó 1080</span> ‚Ä¢ <span id="safeZoneInfo">Standard Safe Zone</span>
      </div>
    </div>
    
    <!-- Right Panel: Tools & Properties -->
    <div class="properties-panel">
      <div class="toolbar property-section collapsible" id="shapesSection">
        <div class="panel-header-collapsible" onclick="togglePanel('shapesSection')">
          <span class="toolbar-title" style="margin-bottom: 0;">Basic Shapes</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="panel-content">
        <div class="tool-grid">
          <button class="tool-btn" onclick="addElement('text')" title="Add Text">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <path d="M4 7V4h16v3M9 20h6M12 4v16"/>
            </svg>
            <span>Text</span>
          </button>
          <button class="tool-btn" onclick="addElement('image')" title="Add Image">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
              <circle cx="8.5" cy="8.5" r="1.5"/>
              <polyline points="21 15 16 10 5 21"/>
            </svg>
            <span>Image</span>
          </button>
          <button class="tool-btn" onclick="addElement('rectangle')" title="Add Rectangle">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <rect x="3" y="3" width="18" height="18" rx="2"/>
            </svg>
            <span>Box</span>
          </button>
          <button class="tool-btn" onclick="addElement('circle')" title="Add Circle">
            <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
              <circle cx="12" cy="12" r="10"/>
            </svg>
            <span>Circle</span>
          </button>
        </div>
        </div>
      </div>

      <div class="toolbar property-section collapsible" id="componentsSection">
        <div class="panel-header-collapsible" onclick="togglePanel('componentsSection')">
          <span class="toolbar-title" style="margin-bottom: 0;">Menu Components</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="panel-content">
        <div class="menu-tool-grid">
          <button class="menu-tool-btn" onclick="addMenuElement('menu_item')" title="Add Menu Item">
            <span class="icon">üçî</span>
            <span class="label">Menu Item</span>
          </button>
          <button class="menu-tool-btn" onclick="addMenuElement('menu_section')" title="Add Section Header">
            <span class="icon">üìã</span>
            <span class="label">Section</span>
          </button>
          <button class="menu-tool-btn" onclick="addMenuElement('price_list')" title="Add Price List">
            <span class="icon">üí∞</span>
            <span class="label">Price List</span>
          </button>
          <button class="menu-tool-btn" onclick="addMenuElement('combo')" title="Add Combo/Special">
            <span class="icon">‚≠ê</span>
            <span class="label">Combo</span>
          </button>
          <button class="menu-tool-btn" onclick="addMenuElement('category_header')" title="Add Category Header">
            <span class="icon">üè∑Ô∏è</span>
            <span class="label">Category</span>
          </button>
          <button class="menu-tool-btn" onclick="addMenuElement('ticker')" title="Add Ticker/Scroller">
            <span class="icon">üìú</span>
            <span class="label">Ticker</span>
          </button>
          <button class="menu-tool-btn" onclick="addElement('group')" title="Group Container">
            <span class="icon">üì¶</span>
            <span class="label">Group</span>
          </button>
        </div>
        </div>
      </div>

      <div class="toolbar property-section collapsible" id="templatesSection">
        <div class="panel-header-collapsible" onclick="togglePanel('templatesSection')">
          <span class="toolbar-title" style="margin-bottom: 0;">Templates</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="panel-content">
        <button class="btn btn-secondary" onclick="showTemplateModal()" style="width: 100%; justify-content: center;">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
            <rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/>
            <rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/>
          </svg>
          Insert Template
        </button>
        </div>
      </div>
      
      <div class="property-section collapsible" id="screenProperties">
        <div class="panel-header-collapsible" onclick="togglePanel('screenProperties')">
          <span class="property-section-title" style="margin-bottom: 0;">Screen Settings</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="panel-content">
        <div class="property-row" style="margin-top: 12px;">
          <span class="property-label">Name</span>
          <input type="text" class="property-input" id="screenNameInput" placeholder="Screen name" onchange="updateScreenName()">
        </div>
        <div class="property-row">
          <span class="property-label">Resolution</span>
          <select class="property-input" id="resolutionSelect" onchange="updateResolution()">
            <!-- Options added dynamically -->
          </select>
        </div>
        <div class="property-row">
          <span class="property-label">Safe Zone</span>
          <select class="property-input" id="safeZoneSelect" onchange="updateSafeZone()">
            <option value="none">None</option>
            <option value="minimal">Minimal (20px)</option>
            <option value="standard" selected>Standard (48px)</option>
            <option value="generous">Generous (80px)</option>
            <option value="tv_1080p">TV 1080p (60px)</option>
            <option value="tv_4k">TV 4K (120px)</option>
            <option value="kiosk">Kiosk (40px)</option>
          </select>
        </div>
        <div class="property-row">
          <span class="property-label">Background</span>
          <input type="color" class="property-input" id="bgColorInput" value="#000000" onchange="updateBackground()" style="width: 60px; padding: 2px;">
          <input type="text" class="property-input" id="bgImageInput" placeholder="Image URL" style="margin-left: 8px;" onchange="updateBackground()">
        </div>
        </div>
      </div>
      
      <div class="property-section" id="elementProperties" style="display: none;">
        <div class="property-section-title" id="elemPropTitle">Element Properties</div>
        
        <!-- Property Tabs -->
        <div class="property-tabs">
          <button class="property-tab active" onclick="switchPropertyTab('layout')">Layout</button>
          <button class="property-tab" onclick="switchPropertyTab('style')">Style</button>
          <button class="property-tab" onclick="switchPropertyTab('actions')">Actions</button>
        </div>
        
        <!-- Layout Tab -->
        <div class="property-tab-content active" id="propTabLayout">
          <div class="property-row">
            <span class="property-label">Position</span>
            <div class="property-input-group">
              <input type="number" class="property-input property-input-small" id="elemX" placeholder="X" onchange="updateElementPosition()">
              <input type="number" class="property-input property-input-small" id="elemY" placeholder="Y" onchange="updateElementPosition()">
            </div>
          </div>
          <div class="property-row">
            <span class="property-label">Size</span>
            <div class="property-input-group">
              <input type="number" class="property-input property-input-small" id="elemW" placeholder="W" onchange="updateElementSize()">
              <input type="number" class="property-input property-input-small" id="elemH" placeholder="H" onchange="updateElementSize()">
            </div>
          </div>
          <div class="layout-toolbar" style="margin-top: 12px;">
            <button class="layout-btn" onclick="alignElement('left')" title="Align Left">‚¨Ö</button>
            <button class="layout-btn" onclick="alignElement('center')" title="Center Horizontal">‚Üî</button>
            <button class="layout-btn" onclick="alignElement('right')" title="Align Right">‚û°</button>
            <button class="layout-btn" onclick="alignElement('top')" title="Align Top">‚¨Ü</button>
            <button class="layout-btn" onclick="alignElement('middle')" title="Center Vertical">‚Üï</button>
            <button class="layout-btn" onclick="alignElement('bottom')" title="Align Bottom">‚¨á</button>
          </div>
          
          <!-- Nesting Controls -->
          <div class="nesting-toolbar" id="nestingControls">
            <button class="nesting-btn" onclick="groupSelectedElements()" title="Group with other selected">üì¶ Group</button>
            <button class="nesting-btn" onclick="ungroupElement()" title="Ungroup children">üì§ Ungroup</button>
          </div>
        </div>
        
        <!-- Style Tab -->
        <div class="property-tab-content" id="propTabStyle">
          <div class="property-row" id="textContentRow" style="display: none;">
            <span class="property-label">Text</span>
            <input type="text" class="property-input" id="elemText" placeholder="Enter text" onchange="updateElementContent()">
          </div>
          <div class="property-row" id="fontSizeRow" style="display: none;">
            <span class="property-label">Font Size</span>
            <input type="number" class="property-input" id="elemFontSize" placeholder="24" onchange="updateElementStyle()" style="width: 80px;">
          </div>
          <div class="property-row" id="colorRow">
            <span class="property-label">Color</span>
            <input type="color" class="property-input" id="elemColor" value="#ffffff" onchange="updateElementStyle()" style="width: 60px; padding: 2px;">
          </div>
          <div class="property-row" id="borderRadiusRow" style="display: none;">
            <span class="property-label">Corners</span>
            <input type="number" class="property-input" id="elemBorderRadius" placeholder="0" min="0" onchange="updateElementStyle()" style="width: 80px;">
          </div>
          <div class="property-row" id="opacityRow">
            <span class="property-label">Opacity</span>
            <input type="range" id="elemOpacity" min="0" max="100" value="100" onchange="updateElementStyle()" style="flex: 1;">
            <span id="elemOpacityValue" style="margin-left: 8px; font-size: 12px; color: var(--text-muted);">100%</span>
          </div>
        </div>
        
        <!-- Actions Tab -->
        <div class="property-tab-content" id="propTabActions">
          <div class="property-row">
            <button class="btn btn-secondary" onclick="duplicateSelectedElement()" style="width: 100%; justify-content: center;">
              üìã Duplicate
            </button>
          </div>
          <div class="property-row">
            <button class="btn btn-secondary" onclick="bringToFront()" style="flex: 1; justify-content: center;">
              ‚¨Ü Front
            </button>
            <button class="btn btn-secondary" onclick="sendToBack()" style="flex: 1; justify-content: center; margin-left: 8px;">
              ‚¨á Back
            </button>
          </div>
          <div class="property-row">
            <button class="btn btn-secondary" onclick="lockElement()" style="flex: 1; justify-content: center;" id="lockElementBtn">
              üîì Lock
            </button>
            <button class="btn btn-secondary" onclick="hideElement()" style="flex: 1; justify-content: center; margin-left: 8px;" id="hideElementBtn">
              üëÅ Hide
            </button>
          </div>
          <div class="property-row" style="margin-top: 12px;">
            <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
              üóë Delete Element
            </button>
          </div>
        </div>
      </div>

      <!-- Menu Item Properties -->
      <div class="property-section menu-item-props" id="menuItemProps" style="display: none;">
        <div class="property-section-title">üçî Menu Item</div>
        <div class="property-row">
          <span class="property-label">Name</span>
          <input type="text" class="property-input" id="menuItemName" placeholder="Item name" onchange="updateMenuItemData()">
        </div>
        <div class="property-row" style="flex-direction: column; align-items: stretch;">
          <span class="property-label" style="width: 100%; margin-bottom: 6px;">Description</span>
          <textarea class="property-textarea" id="menuItemDesc" placeholder="Item description" onchange="updateMenuItemData()"></textarea>
        </div>
        <div class="property-row">
          <span class="property-label">Price</span>
          <input type="text" class="property-input" id="menuItemPrice" placeholder="$0.00" onchange="updateMenuItemData()">
        </div>
        <div class="property-row" style="flex-direction: column; align-items: stretch;">
          <span class="property-label" style="width: 100%; margin-bottom: 6px;">Image</span>
          <div style="display: flex; gap: 8px;">
            <input type="text" class="property-input" id="menuItemImage" placeholder="Image URL or paste link" onchange="updateMenuItemData()" style="flex: 1;">
            <button class="btn btn-secondary" onclick="browseStockImages()" title="Browse stock images" style="padding: 8px 12px;">üì∑</button>
          </div>
          <div id="menuItemImagePreview" style="margin-top: 8px; display: none;">
            <img id="menuItemImageThumb" style="max-width: 100%; max-height: 80px; border-radius: 4px; object-fit: cover;">
          </div>
        </div>
        <div class="property-row toggle-row">
          <span class="property-label">Show Image</span>
          <div class="toggle-switch" id="menuItemShowImage" onclick="toggleMenuItemImage()"></div>
        </div>
        <div class="property-row">
          <span class="property-label">Image Fit</span>
          <select class="property-input" id="menuItemImageFit" onchange="updateMenuItemData()" style="width: 100px;">
            <option value="cover">Cover</option>
            <option value="contain">Contain</option>
            <option value="fill">Fill</option>
            <option value="none">None</option>
          </select>
        </div>
        <div class="property-row toggle-row">
          <span class="property-label">Lock Aspect</span>
          <div class="toggle-switch active" id="menuItemLockAspect" onclick="toggleLockAspect()"></div>
        </div>
        <div class="property-row">
          <span class="property-label">Opacity</span>
          <input type="range" id="menuItemOpacity" min="0" max="100" value="100" onchange="updateMenuItemData()" style="flex: 1;">
          <span id="menuItemOpacityValue" style="margin-left: 8px; font-size: 12px; color: var(--text-muted);">100%</span>
        </div>
        <div class="property-row">
          <span class="property-label">Font Size</span>
          <input type="number" class="property-input" id="menuItemFontSize" value="24" onchange="updateMenuItemData()" style="width: 80px;">
        </div>
        <div class="layout-toolbar">
          <button class="layout-btn" onclick="alignElement('left')" title="Align Left">‚¨Ö</button>
          <button class="layout-btn" onclick="alignElement('center')" title="Align Center">‚Üî</button>
          <button class="layout-btn" onclick="alignElement('right')" title="Align Right">‚û°</button>
        </div>
        <div class="property-row" style="margin-top: 12px;">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete Item
          </button>
        </div>
      </div>

      <!-- Menu Section Properties -->
      <div class="property-section menu-section-props" id="menuSectionProps" style="display: none;">
        <div class="property-section-title">üìã Menu Section</div>
        <div class="property-row">
          <span class="property-label">Title</span>
          <input type="text" class="property-input" id="sectionTitle" placeholder="Section title" onchange="updateSectionData()">
        </div>
        <div class="property-row">
          <span class="property-label">Font Size</span>
          <input type="number" class="property-input" id="sectionFontSize" value="36" onchange="updateSectionData()" style="width: 80px;">
        </div>
        <div class="property-row">
          <span class="property-label">Color</span>
          <input type="color" class="property-input" id="sectionColor" value="#ffffff" onchange="updateSectionData()" style="width: 60px; padding: 2px;">
        </div>
        <div class="property-row toggle-row">
          <span class="property-label">Show Divider</span>
          <div class="toggle-switch active" id="sectionShowDivider" onclick="toggleSectionDivider()"></div>
        </div>
        <div class="property-row">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete Section
          </button>
        </div>
      </div>

      <!-- Price List Properties -->
      <div class="property-section price-list-props" id="priceListProps" style="display: none;">
        <div class="property-section-title">üí∞ Price List</div>
        <div class="property-row" style="flex-direction: column; align-items: stretch;">
          <span class="property-label" style="width: 100%; margin-bottom: 6px;">Items (one per line: Name | Price)</span>
          <textarea class="property-textarea" id="priceListItems" placeholder="Espresso | $3.50&#10;Latte | $4.50&#10;Cappuccino | $4.00" onchange="updatePriceListData()" style="min-height: 120px;"></textarea>
        </div>
        <div class="property-row">
          <span class="property-label">Font Size</span>
          <input type="number" class="property-input" id="priceListFontSize" value="18" onchange="updatePriceListData()" style="width: 80px;">
        </div>
        <div class="property-row">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete List
          </button>
        </div>
      </div>

      <!-- Combo/Special Properties -->
      <div class="property-section combo-props" id="comboProps" style="display: none;">
        <div class="property-section-title">‚≠ê Combo / Special</div>
        <div class="property-row">
          <span class="property-label">Title</span>
          <input type="text" class="property-input" id="comboTitle" placeholder="Combo name" onchange="updateComboData()">
        </div>
        <div class="property-row">
          <span class="property-label">Badge</span>
          <input type="text" class="property-input" id="comboBadge" placeholder="SPECIAL" onchange="updateComboData()">
        </div>
        <div class="property-row" style="flex-direction: column; align-items: stretch;">
          <span class="property-label" style="width: 100%; margin-bottom: 6px;">Items Included</span>
          <textarea class="property-textarea" id="comboItems" placeholder="Burger + Fries + Drink" onchange="updateComboData()"></textarea>
        </div>
        <div class="property-row">
          <span class="property-label">Price</span>
          <input type="text" class="property-input" id="comboPrice" placeholder="$9.99" onchange="updateComboData()">
        </div>
        <div class="property-row">
          <span class="property-label">Background</span>
          <input type="color" class="property-input" id="comboBgColor" value="#7c3aed" onchange="updateComboData()" style="width: 60px; padding: 2px;">
        </div>
        <div class="property-row">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete Combo
          </button>
        </div>
      </div>

      <!-- Category Header Properties -->
      <div class="property-section category-props" id="categoryProps" style="display: none;">
        <div class="property-section-title">üè∑Ô∏è Category Header</div>
        <div class="property-row">
          <span class="property-label">Title</span>
          <input type="text" class="property-input" id="categoryTitle" placeholder="APPETIZERS" onchange="updateCategoryData()">
        </div>
        <div class="property-row">
          <span class="property-label">Subtitle</span>
          <input type="text" class="property-input" id="categorySubtitle" placeholder="Start your meal right" onchange="updateCategoryData()">
        </div>
        <div class="property-row">
          <span class="property-label">Icon</span>
          <input type="text" class="property-input" id="categoryIcon" placeholder="üçΩÔ∏è" onchange="updateCategoryData()" style="width: 60px;">
        </div>
        <div class="property-row">
          <span class="property-label">Font Size</span>
          <input type="number" class="property-input" id="categoryFontSize" value="42" onchange="updateCategoryData()" style="width: 80px;">
        </div>
        <div class="property-row">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete Header
          </button>
        </div>
      </div>

      <!-- Ticker Properties -->
      <div class="property-section ticker-props" id="tickerProps" style="display: none;">
        <div class="property-section-title">üìú Ticker / Scroller</div>
        <div class="property-row" style="flex-direction: column; align-items: stretch;">
          <span class="property-label" style="width: 100%; margin-bottom: 6px;">Messages (one per line)</span>
          <textarea class="property-textarea" id="tickerMessages" placeholder="Welcome to our restaurant!&#10;Try our daily special!&#10;Happy Hour 4-6pm" onchange="updateTickerData()" style="min-height: 100px;"></textarea>
        </div>
        <div class="property-row">
          <span class="property-label">Speed</span>
          <select class="property-input" id="tickerSpeed" onchange="updateTickerData()">
            <option value="30">Slow</option>
            <option value="20" selected>Normal</option>
            <option value="10">Fast</option>
          </select>
        </div>
        <div class="property-row">
          <span class="property-label">Background</span>
          <input type="color" class="property-input" id="tickerBgColor" value="#000000" onchange="updateTickerData()" style="width: 60px; padding: 2px;">
        </div>
        <div class="property-row">
          <span class="property-label">Text Color</span>
          <input type="color" class="property-input" id="tickerTextColor" value="#ffffff" onchange="updateTickerData()" style="width: 60px; padding: 2px;">
        </div>
        <div class="property-row">
          <button class="btn btn-secondary" onclick="deleteSelectedElement()" style="width: 100%; justify-content: center; color: var(--danger);">
            Delete Ticker
          </button>
        </div>
      </div>
      
      <div class="toolbar property-section collapsible" id="layersSection">
        <div class="panel-header-collapsible" onclick="togglePanel('layersSection')">
          <span class="toolbar-title" style="margin-bottom: 0;">Layers</span>
          <span class="collapse-icon">‚ñº</span>
        </div>
        <div class="panel-content">
      <div class="layers-panel" id="layersList">
        <!-- Layers rendered here -->
      </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Add Screen Modal -->
  <div class="modal-overlay" id="addScreenModal">
    <div class="modal">
      <div class="modal-header">
        <h3 class="modal-title">Add New Screen</h3>
        <button class="modal-close" onclick="hideAddScreenModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="property-row" style="margin-bottom: 16px;">
          <span class="property-label" style="width: 100px;">Screen Name</span>
          <input type="text" class="property-input" id="newScreenName" placeholder="e.g., Main Display">
        </div>
        <div class="property-section-title" style="margin-bottom: 12px;">Select Resolution</div>
        <div class="resolution-grid" id="resolutionGrid">
          <!-- Resolution options added dynamically -->
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideAddScreenModal()">Cancel</button>
        <button class="btn btn-primary" onclick="createScreen()">Add Screen</button>
      </div>
    </div>
  </div>

  <!-- Template Modal -->
  <div class="modal-overlay" id="templateModal">
    <div class="modal" style="max-width: 600px;">
      <div class="modal-header">
        <h3 class="modal-title">Insert Template</h3>
        <button class="modal-close" onclick="hideTemplateModal()">√ó</button>
      </div>
      <div class="modal-body">
        <div class="template-grid" id="templateGrid">
          <div class="template-card" data-template="two_column" onclick="selectTemplate('two_column')">
            <div class="template-preview">üìä</div>
            <div class="template-name">2-Column Menu</div>
            <div class="template-desc">Classic split layout with header</div>
          </div>
          <div class="template-card" data-template="three_column" onclick="selectTemplate('three_column')">
            <div class="template-preview">üìã</div>
            <div class="template-name">3-Column Menu</div>
            <div class="template-desc">Wide format with categories</div>
          </div>
          <div class="template-card" data-template="specials" onclick="selectTemplate('specials')">
            <div class="template-preview">‚≠ê</div>
            <div class="template-name">Specials Board</div>
            <div class="template-desc">Featured items with badges</div>
          </div>
          <div class="template-card" data-template="drinks" onclick="selectTemplate('drinks')">
            <div class="template-preview">üç∫</div>
            <div class="template-name">Drinks Board</div>
            <div class="template-desc">Beverages with price lists</div>
          </div>
          <div class="template-card" data-template="price_board" onclick="selectTemplate('price_board')">
            <div class="template-preview">üí∞</div>
            <div class="template-name">Price Board</div>
            <div class="template-desc">Clean price list layout</div>
          </div>
          <div class="template-card" data-template="combo_deal" onclick="selectTemplate('combo_deal')">
            <div class="template-preview">üéâ</div>
            <div class="template-name">Combo Deals</div>
            <div class="template-desc">Promotions and bundles</div>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="hideTemplateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="insertTemplate()">Insert Template</button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '/api';
    
    // Resolution profiles (matching backend)
    const RESOLUTIONS = {
      '720p': { w: 1280, h: 720, label: 'HD 720p' },
      '1080p': { w: 1920, h: 1080, label: 'Full HD 1080p' },
      '4k': { w: 3840, h: 2160, label: '4K UHD' },
      '1080p_portrait': { w: 1080, h: 1920, label: '1080p Portrait' },
      '4k_portrait': { w: 2160, h: 3840, label: '4K Portrait' },
      'kiosk_portrait': { w: 1080, h: 1920, label: 'Kiosk Portrait' },
      'kiosk_landscape': { w: 1920, h: 1080, label: 'Kiosk Landscape' },
      'ultrawide': { w: 2560, h: 1080, label: 'Ultra-wide 21:9' },
      'square_1080': { w: 1080, h: 1080, label: 'Square 1080' }
    };
    
    const SAFE_ZONES = {
      none: 0,
      minimal: 20,
      standard: 48,
      generous: 80,
      tv_1080p: 60,
      tv_4k: 120,
      kiosk: 40
    };

    // Menu element type definitions
    const MENU_ELEMENT_DEFAULTS = {
      menu_item: {
        width: 500,
        height: 120,
        data: {
          name: 'New Item',
          description: 'Delicious item description',
          price: '$9.99',
          image: '',
          showImage: true
        },
        style: {
          fontSize: 24,
          bgColor: 'rgba(0,0,0,0.6)'
        }
      },
      menu_section: {
        width: 400,
        height: 80,
        data: {
          title: 'SECTION TITLE',
          showDivider: true
        },
        style: {
          fontSize: 36,
          color: '#ffffff'
        }
      },
      price_list: {
        width: 400,
        height: 200,
        data: {
          items: [
            { name: 'Item One', price: '$5.99' },
            { name: 'Item Two', price: '$6.99' },
            { name: 'Item Three', price: '$7.99' }
          ]
        },
        style: {
          fontSize: 18,
          bgColor: 'rgba(0,0,0,0.5)'
        }
      },
      combo: {
        width: 400,
        height: 180,
        data: {
          title: 'Combo Deal',
          badge: 'SPECIAL',
          items: 'Main + Side + Drink',
          price: '$12.99'
        },
        style: {
          bgColor: '#7c3aed'
        }
      },
      category_header: {
        width: 500,
        height: 150,
        data: {
          title: 'APPETIZERS',
          subtitle: 'Start your meal right',
          icon: 'üçΩÔ∏è'
        },
        style: {
          fontSize: 42
        }
      },
      ticker: {
        width: 800,
        height: 50,
        data: {
          messages: ['Welcome!', 'Try our daily special!', 'Happy Hour 4-6pm'],
          speed: 20
        },
        style: {
          bgColor: '#000000',
          textColor: '#ffffff'
        }
      }
    };

    // Menu template definitions
    const TEMPLATES = {
      two_column: {
        name: '2-Column Menu',
        elements: [
          { type: 'category_header', x: 160, y: 60, width: 600, height: 120, data: { title: 'OUR MENU', subtitle: 'Fresh & Delicious', icon: 'üçΩÔ∏è' }, style: { fontSize: 48 } },
          { type: 'menu_section', x: 100, y: 200, width: 350, height: 60, data: { title: 'MAINS', showDivider: true }, style: { fontSize: 28, color: '#ffffff' } },
          { type: 'menu_item', x: 100, y: 280, width: 350, height: 100, data: { name: 'Classic Burger', description: 'Angus beef, lettuce, tomato', price: '$12.99', showImage: false }, style: { fontSize: 20 } },
          { type: 'menu_item', x: 100, y: 400, width: 350, height: 100, data: { name: 'Grilled Chicken', description: 'Herb-marinated, seasonal veggies', price: '$14.99', showImage: false }, style: { fontSize: 20 } },
          { type: 'menu_section', x: 500, y: 200, width: 350, height: 60, data: { title: 'SIDES', showDivider: true }, style: { fontSize: 28, color: '#ffffff' } },
          { type: 'menu_item', x: 500, y: 280, width: 350, height: 100, data: { name: 'French Fries', description: 'Crispy golden fries', price: '$4.99', showImage: false }, style: { fontSize: 20 } },
          { type: 'menu_item', x: 500, y: 400, width: 350, height: 100, data: { name: 'Onion Rings', description: 'Beer-battered, served hot', price: '$5.99', showImage: false }, style: { fontSize: 20 } }
        ]
      },
      three_column: {
        name: '3-Column Menu',
        elements: [
          { type: 'text', x: 60, y: 40, width: 800, height: 60, content: 'RESTAURANT NAME', fontSize: 48, color: '#ffffff' },
          { type: 'menu_section', x: 60, y: 120, width: 280, height: 50, data: { title: 'STARTERS', showDivider: true }, style: { fontSize: 24, color: '#00d4ff' } },
          { type: 'price_list', x: 60, y: 180, width: 280, height: 200, data: { items: [{ name: 'Soup of Day', price: '$6' }, { name: 'Garden Salad', price: '$8' }, { name: 'Wings', price: '$10' }] }, style: { fontSize: 16 } },
          { type: 'menu_section', x: 360, y: 120, width: 280, height: 50, data: { title: 'MAINS', showDivider: true }, style: { fontSize: 24, color: '#00d4ff' } },
          { type: 'price_list', x: 360, y: 180, width: 280, height: 200, data: { items: [{ name: 'Steak', price: '$24' }, { name: 'Salmon', price: '$22' }, { name: 'Pasta', price: '$18' }] }, style: { fontSize: 16 } },
          { type: 'menu_section', x: 660, y: 120, width: 280, height: 50, data: { title: 'DESSERTS', showDivider: true }, style: { fontSize: 24, color: '#00d4ff' } },
          { type: 'price_list', x: 660, y: 180, width: 280, height: 200, data: { items: [{ name: 'Cheesecake', price: '$8' }, { name: 'Ice Cream', price: '$6' }, { name: 'Brownie', price: '$7' }] }, style: { fontSize: 16 } }
        ]
      },
      specials: {
        name: 'Specials Board',
        elements: [
          { type: 'category_header', x: 160, y: 40, width: 600, height: 100, data: { title: "TODAY'S SPECIALS", subtitle: 'Limited Time Only!', icon: '‚≠ê' }, style: { fontSize: 42 } },
          { type: 'combo', x: 100, y: 180, width: 380, height: 200, data: { title: 'Lunch Special', badge: 'BEST VALUE', items: 'Sandwich + Soup + Drink', price: '$11.99' }, style: { bgColor: '#059669' } },
          { type: 'combo', x: 520, y: 180, width: 380, height: 200, data: { title: 'Family Feast', badge: 'FEEDS 4', items: '2 Mains + 2 Sides + Drinks', price: '$39.99' }, style: { bgColor: '#7c3aed' } },
          { type: 'combo', x: 100, y: 420, width: 380, height: 200, data: { title: 'Date Night', badge: 'FOR TWO', items: '2 Entrees + Dessert + Wine', price: '$49.99' }, style: { bgColor: '#dc2626' } },
          { type: 'ticker', x: 60, y: 650, width: 880, height: 50, data: { messages: ['Ask about our loyalty program!', 'Free delivery on orders over $30'], speed: 20 }, style: { bgColor: '#000', textColor: '#fff' } }
        ]
      },
      drinks: {
        name: 'Drinks Board',
        elements: [
          { type: 'category_header', x: 160, y: 40, width: 600, height: 100, data: { title: 'BEVERAGES', subtitle: 'Refreshing Drinks', icon: 'üç∫' }, style: { fontSize: 42 } },
          { type: 'menu_section', x: 80, y: 160, width: 350, height: 50, data: { title: 'COFFEE', showDivider: true }, style: { fontSize: 24, color: '#f59e0b' } },
          { type: 'price_list', x: 80, y: 220, width: 350, height: 180, data: { items: [{ name: 'Espresso', price: '$3.00' }, { name: 'Americano', price: '$3.50' }, { name: 'Latte', price: '$4.50' }, { name: 'Cappuccino', price: '$4.50' }] }, style: { fontSize: 16 } },
          { type: 'menu_section', x: 500, y: 160, width: 350, height: 50, data: { title: 'COLD DRINKS', showDivider: true }, style: { fontSize: 24, color: '#00d4ff' } },
          { type: 'price_list', x: 500, y: 220, width: 350, height: 180, data: { items: [{ name: 'Iced Tea', price: '$3.00' }, { name: 'Lemonade', price: '$3.50' }, { name: 'Smoothie', price: '$5.50' }, { name: 'Milkshake', price: '$5.50' }] }, style: { fontSize: 16 } },
          { type: 'menu_section', x: 80, y: 430, width: 350, height: 50, data: { title: 'BEER', showDivider: true }, style: { fontSize: 24, color: '#f59e0b' } },
          { type: 'price_list', x: 80, y: 490, width: 350, height: 140, data: { items: [{ name: 'Draft Beer', price: '$5.00' }, { name: 'Craft IPA', price: '$7.00' }, { name: 'Import', price: '$6.00' }] }, style: { fontSize: 16 } }
        ]
      },
      price_board: {
        name: 'Price Board',
        elements: [
          { type: 'text', x: 60, y: 40, width: 800, height: 50, content: 'MENU', fontSize: 42, color: '#ffffff' },
          { type: 'price_list', x: 60, y: 120, width: 400, height: 250, data: { items: [{ name: 'Item 1', price: '$8.99' }, { name: 'Item 2', price: '$9.99' }, { name: 'Item 3', price: '$10.99' }, { name: 'Item 4', price: '$11.99' }, { name: 'Item 5', price: '$12.99' }] }, style: { fontSize: 20 } },
          { type: 'price_list', x: 500, y: 120, width: 400, height: 250, data: { items: [{ name: 'Item 6', price: '$13.99' }, { name: 'Item 7', price: '$14.99' }, { name: 'Item 8', price: '$15.99' }, { name: 'Item 9', price: '$16.99' }, { name: 'Item 10', price: '$17.99' }] }, style: { fontSize: 20 } },
          { type: 'rectangle', x: 60, y: 400, width: 840, height: 3, color: '#00d4ff' }
        ]
      },
      combo_deal: {
        name: 'Combo Deals',
        elements: [
          { type: 'category_header', x: 160, y: 30, width: 600, height: 100, data: { title: 'COMBO DEALS', subtitle: 'Save More!', icon: 'üéâ' }, style: { fontSize: 42 } },
          { type: 'combo', x: 60, y: 150, width: 420, height: 180, data: { title: 'Combo #1', badge: 'POPULAR', items: 'Burger + Fries + Drink', price: '$9.99' }, style: { bgColor: '#dc2626' } },
          { type: 'combo', x: 520, y: 150, width: 420, height: 180, data: { title: 'Combo #2', badge: 'VALUE', items: 'Chicken + Salad + Drink', price: '$10.99' }, style: { bgColor: '#059669' } },
          { type: 'combo', x: 60, y: 360, width: 420, height: 180, data: { title: 'Combo #3', badge: 'DELUXE', items: 'Steak + Sides + Dessert', price: '$18.99' }, style: { bgColor: '#7c3aed' } },
          { type: 'combo', x: 520, y: 360, width: 420, height: 180, data: { title: 'Family Pack', badge: 'FEEDS 4', items: '4 Mains + 4 Sides + 4 Drinks', price: '$34.99' }, style: { bgColor: '#0891b2' } }
        ]
      }
    };
    
    // State
    let currentSession = null;
    let currentMenu = null;
    let layouts = [];
    let activeLayoutId = null;
    let selectedElement = null;
    let zoom = 1;
    let isDragging = false;
    let dragOffset = { x: 0, y: 0 };
    let selectedTemplate = null;
    
    // Undo/Redo History
    let historyStack = [];
    let historyIndex = -1;
    const MAX_HISTORY = 50;
    
    // Save state to history
    function saveToHistory() {
      const activeLayout = layouts.find(l => l.id === activeLayoutId);
      if (!activeLayout) return;
      
      const state = JSON.stringify(activeLayout.elements || []);
      
      // Remove any future states if we're not at the end
      if (historyIndex < historyStack.length - 1) {
        historyStack = historyStack.slice(0, historyIndex + 1);
      }
      
      // Don't save if state hasn't changed
      if (historyStack.length > 0 && historyStack[historyIndex] === state) {
        return;
      }
      
      historyStack.push(state);
      if (historyStack.length > MAX_HISTORY) {
        historyStack.shift();
      } else {
        historyIndex++;
      }
      
      updateHistoryButtons();
    }
    
    function undo() {
      if (historyIndex <= 0) return;
      
      historyIndex--;
      applyHistoryState();
    }
    
    function redo() {
      if (historyIndex >= historyStack.length - 1) return;
      
      historyIndex++;
      applyHistoryState();
    }
    
    function applyHistoryState() {
      const activeLayout = layouts.find(l => l.id === activeLayoutId);
      if (!activeLayout || !historyStack[historyIndex]) return;
      
      activeLayout.elements = JSON.parse(historyStack[historyIndex]);
      selectedElement = null;
      renderCanvas(activeLayout);
      renderLayers(activeLayout);
      hideAllMenuProps();
      updateHistoryButtons();
    }
    
    function updateHistoryButtons() {
      const undoBtn = document.getElementById('undoBtn');
      const redoBtn = document.getElementById('redoBtn');
      if (undoBtn) undoBtn.disabled = historyIndex <= 0;
      if (redoBtn) redoBtn.disabled = historyIndex >= historyStack.length - 1;
    }
    
    function clearHistory() {
      historyStack = [];
      historyIndex = -1;
      updateHistoryButtons();
    }
    
    // Panel collapse toggle
    function togglePanel(panelId) {
      const panel = document.getElementById(panelId);
      if (panel) {
        panel.classList.toggle('collapsed');
      }
    }
    
    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
      // Undo: Ctrl+Z or Cmd+Z
      if ((e.ctrlKey || e.metaKey) && e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      }
      // Redo: Ctrl+Shift+Z or Cmd+Shift+Z or Ctrl+Y
      if ((e.ctrlKey || e.metaKey) && (e.key === 'Z' || e.key === 'y')) {
        e.preventDefault();
        redo();
      }
      // Delete element
      if ((e.key === 'Delete' || e.key === 'Backspace') && selectedElement !== null && !e.target.matches('input, textarea')) {
        e.preventDefault();
        deleteSelectedElement();
      }
    });
    
    // Initialize
    async function init() {
      document.getElementById('menuName').textContent = 'Initializing...';
      console.log('Editor init starting...');
      
      // Check auth
      const sessionStr = localStorage.getItem('mosm_session');
      if (!sessionStr) {
        console.log('No session found, redirecting to login');
        document.getElementById('menuName').textContent = 'No session - redirecting...';
        window.location.href = '/login.html';
        return;
      }
      
      try {
        currentSession = JSON.parse(sessionStr);
        document.getElementById('menuName').textContent = 'Session OK...';
        console.log('Session loaded successfully');
      } catch (e) {
        console.error('Failed to parse session:', e);
        document.getElementById('menuName').textContent = 'Bad session - redirecting...';
        window.location.href = '/login.html';
        return;
      }
      
      // Get menu ID from URL hash
      const hash = window.location.hash;
      console.log('Hash:', hash);
      document.getElementById('menuName').textContent = 'Parsing URL...';
      const menuIdMatch = hash.match(/menus\/([a-f0-9-]+)/);
      
      if (!menuIdMatch) {
        console.error('No menu ID in hash');
        document.getElementById('menuName').textContent = 'No menu ID!';
        alert('No menu ID provided');
        window.location.href = '/admin.html';
        return;
      }
      
      const menuId = menuIdMatch[1];
      console.log('Menu ID:', menuId);
      document.getElementById('menuName').textContent = 'Loading menu...';
      
      // Load menu and layouts
      try {
        console.log('Loading menu...');
        await loadMenu(menuId);
        console.log('Menu loaded, loading layouts...');
        document.getElementById('menuName').textContent = currentMenu?.name || 'Loading layouts...';
        await loadLayouts(menuId);
        console.log('Layouts loaded');
      } catch (error) {
        console.error('Error loading data:', error);
        document.getElementById('menuName').textContent = 'Error: ' + error.message;
        return;
      }
      
      // Populate resolution dropdowns
      populateResolutionSelect();
      populateResolutionGrid();
      
      // Setup canvas interactions
      setupCanvasInteractions();
      console.log('Editor init complete');
    }
    
    // API helper
    async function apiRequest(endpoint, options = {}) {
      console.log('apiRequest:', endpoint);
      const headers = {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${currentSession.access_token}`,
        ...options.headers
      };
      
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          ...options,
          headers
        });
        
        console.log('Response status:', response.status);
        const data = await response.json();
        console.log('Response data:', data);
        
        if (!response.ok) {
          throw new Error(data.error || 'Request failed');
        }
        
        return data;
      } catch (error) {
        console.error('apiRequest error:', error);
        throw error;
      }
    }
    
    // Load menu
    async function loadMenu(menuId) {
      console.log('loadMenu called with:', menuId);
      try {
        const url = `${API_BASE}/menus/${menuId}`;
        console.log('Fetching:', url);
        const data = await apiRequest(`/menus/${menuId}`);
        console.log('Menu data received:', data);
        currentMenu = data.menu;
        
        if (currentMenu) {
          document.getElementById('menuName').textContent = currentMenu.name;
          document.getElementById('menuStatus').textContent = currentMenu.status;
          document.getElementById('menuStatus').className = `menu-status ${currentMenu.status}`;
          console.log('Menu UI updated:', currentMenu.name);
        } else {
          console.error('No menu in response');
          document.getElementById('menuName').textContent = 'Menu not found';
        }
      } catch (error) {
        console.error('Error loading menu:', error);
        document.getElementById('menuName').textContent = 'Error: ' + error.message;
      }
    }
    
    // Load layouts (screens)
    async function loadLayouts(menuId) {
      try {
        const data = await apiRequest(`/layouts?menuId=${menuId}`);
        layouts = (data.layouts || []).map(normalizeLayout);
        
        renderScreensList();
        
        if (layouts.length > 0) {
          selectLayout(layouts[0].id);
        } else {
          showNoScreensMessage();
        }
      } catch (error) {
        console.error('Error loading layouts:', error);
      }
    }
    
    // Normalize layout data - extract background_color from JSONB background
    function normalizeLayout(layout) {
      // If background is JSONB object, extract color
      if (layout.background && typeof layout.background === 'object') {
        layout.background_color = layout.background.color || layout.background.value || '#000000';
        if (layout.background.type === 'image' && layout.background.value) {
          layout.background_image = layout.background.value;
        }
      }
      // Default if no background_color
      if (!layout.background_color) {
        layout.background_color = '#000000';
      }
      return layout;
    }
    
    // Render screens list
    function renderScreensList() {
      const list = document.getElementById('screensList');
      
      if (layouts.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 13px;">No screens yet</p>';
        return;
      }
      
      list.innerHTML = layouts.map((layout, index) => {
        const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
        const isPortrait = res.h > res.w;
        
        return `
          <div class="screen-card ${layout.id === activeLayoutId ? 'active' : ''}" 
               data-layout-id="${layout.id}"
               data-index="${index}"
               draggable="true"
               ondragstart="onScreenDragStart(event)"
               ondragover="onScreenDragOver(event)"
               ondrop="onScreenDrop(event)"
               ondragend="onScreenDragEnd(event)"
               onclick="selectLayout('${layout.id}')">
            <div class="screen-card-actions">
              <button class="screen-action-btn" onclick="event.stopPropagation(); deleteScreen('${layout.id}')" title="Delete Screen">
                <svg width="12" height="12" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                  <path d="M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14"/>
                </svg>
              </button>
            </div>
            <div class="screen-card-header">
              <span class="screen-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
              <span class="screen-name">${layout.name || 'Untitled Screen'}</span>
            </div>
            <div class="screen-preview ${isPortrait ? 'portrait' : ''}" style="background: ${layout.background_color || '#000'}">
              ${layout.background_image ? `<img src="${layout.background_image}" style="width: 100%; height: 100%; object-fit: cover;">` : `${res.w}√ó${res.h}`}
            </div>
            <div class="screen-resolution">${res.w} √ó ${res.h}</div>
          </div>
        `;
      }).join('');
    }
    
    // Select layout
    function selectLayout(layoutId) {
      activeLayoutId = layoutId;
      selectedElement = null;
      
      const layout = layouts.find(l => l.id === layoutId);
      if (!layout) return;
      
      // Clear and init history for this layout
      clearHistory();
      saveToHistory();
      
      // Update UI
      renderScreensList();
      renderCanvas(layout);
      updatePropertyPanel(layout);
      renderLayers(layout);
      
      // Show canvas
      document.getElementById('noScreensMessage').style.display = 'none';
      document.getElementById('canvasWrapper').style.display = 'block';
      document.getElementById('canvasInfo').style.display = 'block';
    }
    
    // Render canvas
    function renderCanvas(layout) {
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      const safeZoneMargin = SAFE_ZONES[layout.safe_zone || 'standard'] || 48;
      
      const container = document.getElementById('canvasContainer');
      const content = document.getElementById('canvasContent');
      const safeZone = document.getElementById('safeZoneOverlay');
      
      // Set canvas size
      container.style.width = res.w + 'px';
      container.style.height = res.h + 'px';
      container.style.background = layout.background_color || '#000';
      
      if (layout.background_image) {
        container.style.backgroundImage = `url(${layout.background_image})`;
        container.style.backgroundSize = 'cover';
        container.style.backgroundPosition = 'center';
      } else {
        container.style.backgroundImage = 'none';
      }
      
      // Set safe zone
      safeZone.style.margin = safeZoneMargin + 'px';
      
      // Update info
      document.getElementById('resolutionInfo').textContent = `${res.w} √ó ${res.h}`;
      document.getElementById('safeZoneInfo').textContent = layout.safe_zone ? `${layout.safe_zone} (${safeZoneMargin}px)` : 'Standard';
      
      // Render elements (skip hidden ones)
      const elements = layout.elements || [];
      content.innerHTML = elements.map((el, idx) => {
        if (el.hidden) return ''; // Don't render hidden elements
        return renderElement(el, idx);
      }).join('');
      
      // Fit to view
      zoomFit();
    }
    
    // Render single element
    function renderElement(element, index) {
      const style = `
        left: ${element.x}px;
        top: ${element.y}px;
        width: ${element.width}px;
        height: ${element.height}px;
      `;
      
      const selectedClass = selectedElement === index ? 'selected' : '';
      const resizeHandles = selectedElement === index ? getResizeHandles(index) : '';
      
      switch (element.type) {
        case 'text':
          return `
            <div class="canvas-element element-text ${selectedClass}" 
                 data-index="${index}" 
                 style="${style}; font-size: ${element.fontSize || 24}px; color: ${element.color || '#fff'};"
                 onmousedown="startDrag(event, ${index})">
              ${element.content || 'Text'}
              ${resizeHandles}
            </div>
          `;
        case 'image':
          return `
            <div class="canvas-element element-image ${selectedClass}" 
                 data-index="${index}" 
                 style="${style}"
                 onmousedown="startDrag(event, ${index})">
              <img src="${element.src || 'https://via.placeholder.com/200'}" alt="">
              ${resizeHandles}
            </div>
          `;
        case 'rectangle':
          return `
            <div class="canvas-element element-shape ${selectedClass}" 
                 data-index="${index}" 
                 style="${style}; background: ${element.color || '#333'}; border-radius: ${element.borderRadius || 0}px;"
                 onmousedown="startDrag(event, ${index})">
              ${resizeHandles}
            </div>
          `;
        case 'circle':
          return `
            <div class="canvas-element element-shape ${selectedClass}" 
                 data-index="${index}" 
                 style="${style}; background: ${element.color || '#333'}; border-radius: 50%;"
                 onmousedown="startDrag(event, ${index})">
              ${resizeHandles}
            </div>
          `;
        case 'group':
          return `
            <div class="canvas-element element-group ${selectedClass}" 
                 data-index="${index}" 
                 style="${style}; background: ${element.color || 'rgba(0, 212, 255, 0.05)'}; border: 2px dashed ${element.borderColor || 'rgba(0, 212, 255, 0.3)'}; border-radius: 8px;"
                 onmousedown="startDrag(event, ${index})">
              <span class="group-label">üì¶ ${element.name || 'Group'}</span>
              ${resizeHandles}
            </div>
          `;
        
        // Menu-aware components
        case 'menu_item':
          return renderMenuItemElement(element, index, style, selectedClass, resizeHandles);
        case 'menu_section':
          return renderMenuSectionElement(element, index, style, selectedClass, resizeHandles);
        case 'price_list':
          return renderPriceListElement(element, index, style, selectedClass, resizeHandles);
        case 'combo':
          return renderComboElement(element, index, style, selectedClass, resizeHandles);
        case 'category_header':
          return renderCategoryHeaderElement(element, index, style, selectedClass, resizeHandles);
        case 'ticker':
          return renderTickerElement(element, index, style, selectedClass, resizeHandles);
        
        default:
          return '';
      }
    }
    
    // Generate resize handles HTML
    function getResizeHandles(index) {
      return `
        <div class="resize-handle nw" onmousedown="startResize(event, ${index}, 'nw')"></div>
        <div class="resize-handle n" onmousedown="startResize(event, ${index}, 'n')"></div>
        <div class="resize-handle ne" onmousedown="startResize(event, ${index}, 'ne')"></div>
        <div class="resize-handle e" onmousedown="startResize(event, ${index}, 'e')"></div>
        <div class="resize-handle se" onmousedown="startResize(event, ${index}, 'se')"></div>
        <div class="resize-handle s" onmousedown="startResize(event, ${index}, 's')"></div>
        <div class="resize-handle sw" onmousedown="startResize(event, ${index}, 'sw')"></div>
        <div class="resize-handle w" onmousedown="startResize(event, ${index}, 'w')"></div>
      `;
    }

    // Menu Item Renderer
    function renderMenuItemElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      const imageFit = elStyle.imageFit || 'cover';
      const opacity = elStyle.opacity !== undefined ? elStyle.opacity / 100 : 1;
      
      return `
        <div class="canvas-element menu-item-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}; background: ${elStyle.bgColor || 'rgba(0,0,0,0.6)'}; opacity: ${opacity};"
             onmousedown="startDrag(event, ${index})">
          ${data.showImage && data.image ? `<img class="item-image" src="${data.image}" alt="" style="object-fit: ${imageFit};">` : (data.showImage ? '<div class="item-image"></div>' : '')}
          <div class="item-content">
            <div class="item-name" style="font-size: ${elStyle.fontSize || 24}px;">${data.name || 'Item Name'}</div>
            <div class="item-description">${data.description || 'Description'}</div>
            <div class="item-price">${data.price || '$0.00'}</div>
          </div>
          ${resizeHandles || ''}
        </div>
      `;
    }

    // Menu Section Renderer
    function renderMenuSectionElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      return `
        <div class="canvas-element menu-section-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}"
             onmousedown="startDrag(event, ${index})">
          <div class="section-title" style="font-size: ${elStyle.fontSize || 36}px; color: ${elStyle.color || '#fff'};">${data.title || 'SECTION'}</div>
          ${data.showDivider !== false ? '<div class="section-divider"></div>' : ''}
          ${resizeHandles || ''}
        </div>
      `;
    }

    // Price List Renderer
    function renderPriceListElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      const items = data.items || [];
      return `
        <div class="canvas-element price-list-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}; background: ${elStyle.bgColor || 'rgba(0,0,0,0.5)'};"
             onmousedown="startDrag(event, ${index})">
          ${items.map(item => `
            <div class="price-row" style="font-size: ${elStyle.fontSize || 18}px;">
              <span class="price-name">${item.name}</span>
              <span class="price-value">${item.price}</span>
            </div>
          `).join('')}
          ${resizeHandles || ''}
        </div>
      `;
    }

    // Combo/Special Renderer
    function renderComboElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      return `
        <div class="canvas-element combo-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}; background: linear-gradient(135deg, ${elStyle.bgColor || '#7c3aed'}40 0%, ${elStyle.bgColor || '#7c3aed'}20 100%); border-color: ${elStyle.bgColor || '#7c3aed'}80;"
             onmousedown="startDrag(event, ${index})">
          ${data.badge ? `<div class="combo-badge">${data.badge}</div>` : ''}
          <div class="combo-title">${data.title || 'Combo Deal'}</div>
          <div class="combo-items">${data.items || 'Items included'}</div>
          <div class="combo-price">${data.price || '$0.00'}</div>
          ${resizeHandles || ''}
        </div>
      `;
    }

    // Category Header Renderer
    function renderCategoryHeaderElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      return `
        <div class="canvas-element category-header-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}"
             onmousedown="startDrag(event, ${index})">
          ${data.icon ? `<div class="category-icon">${data.icon}</div>` : ''}
          <div class="category-title" style="font-size: ${elStyle.fontSize || 42}px;">${data.title || 'CATEGORY'}</div>
          ${data.subtitle ? `<div class="category-subtitle">${data.subtitle}</div>` : ''}
          ${resizeHandles || ''}
        </div>
      `;
    }

    // Ticker Renderer
    function renderTickerElement(element, index, style, selectedClass, resizeHandles) {
      const data = element.data || {};
      const elStyle = element.style || {};
      const messages = data.messages || ['Message'];
      const speed = data.speed || 20;
      return `
        <div class="canvas-element ticker-element ${selectedClass}" 
             data-index="${index}" 
             style="${style}; background: ${elStyle.bgColor || '#000'};"
             onmousedown="startDrag(event, ${index})">
          <div class="ticker-content" style="color: ${elStyle.textColor || '#fff'}; animation-duration: ${speed}s;">
            ${messages.join(' ‚Ä¢ ')}
          </div>
          ${resizeHandles || ''}
        </div>
      `;
    }
    
    // Update property panel for layout
    function updatePropertyPanel(layout) {
      document.getElementById('screenNameInput').value = layout.name || '';
      document.getElementById('resolutionSelect').value = layout.resolution || '1080p';
      document.getElementById('safeZoneSelect').value = layout.safe_zone || 'standard';
      document.getElementById('bgColorInput').value = layout.background_color || '#000000';
      document.getElementById('bgImageInput').value = layout.background_image || '';
      
      // Hide element properties
      document.getElementById('elementProperties').style.display = 'none';
      document.getElementById('screenProperties').style.display = 'block';
    }
    
    // Render layers panel
    function renderLayers(layout) {
      const list = document.getElementById('layersList');
      const elements = layout.elements || [];
      
      if (elements.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px; font-size: 12px;">No elements yet</p>';
        return;
      }
      
      // Render in reverse order (top layer first)
      list.innerHTML = [...elements].reverse().map((el, idx) => {
        const realIndex = elements.length - 1 - idx;
        const icon = getElementIcon(el.type);
        const isHidden = el.hidden === true;
        const isLocked = el.locked === true;
        const nestedClass = el.parentId ? 'nested' : '';
        
        return `
          <div class="layer-item ${selectedElement === realIndex ? 'selected' : ''} ${isHidden ? 'hidden' : ''} ${isLocked ? 'locked' : ''} ${nestedClass}" 
               data-index="${realIndex}"
               draggable="true"
               ondragstart="onLayerDragStart(event, ${realIndex})"
               ondragover="onLayerDragOver(event)"
               ondrop="onLayerDrop(event, ${realIndex})"
               ondragend="onLayerDragEnd(event)"
               onclick="selectElement(${realIndex})">
            <span class="layer-drag-handle" title="Drag to reorder">‚ãÆ‚ãÆ</span>
            <span class="layer-icon">${icon}</span>
            <span class="layer-name" ondblclick="startRenameLayer(event, ${realIndex})">${el.name || el.type}</span>
            <div class="layer-actions">
              <button class="layer-action-btn ${isLocked ? 'locked-active' : ''}" onclick="toggleLayerLock(event, ${realIndex})" title="${isLocked ? 'Unlock' : 'Lock'}">
                ${isLocked ? 'üîí' : 'üîì'}
              </button>
              <button class="layer-action-btn" onclick="duplicateElement(event, ${realIndex})" title="Duplicate">üìã</button>
              <button class="layer-action-btn" onclick="deleteLayerElement(event, ${realIndex})" title="Delete">üóë</button>
            </div>
            <span class="layer-visibility ${isHidden ? 'hidden' : ''}" onclick="toggleLayerVisibility(event, ${realIndex})" title="${isHidden ? 'Show' : 'Hide'}">
              ${isHidden ? 'üëÅ‚Äçüó®' : 'üëÅ'}
            </span>
          </div>
        `;
      }).join('');
    }
    
    // Layer drag/drop for z-order
    let draggingLayerIndex = null;
    
    function onLayerDragStart(e, index) {
      draggingLayerIndex = index;
      e.target.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    }
    
    function onLayerDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      e.currentTarget.classList.add('drag-over');
    }
    
    function onLayerDrop(e, targetIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      if (draggingLayerIndex === null || draggingLayerIndex === targetIndex) return;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements) return;
      
      // Move element in array (reorder z-index)
      const elements = layout.elements;
      const [moved] = elements.splice(draggingLayerIndex, 1);
      elements.splice(targetIndex, 0, moved);
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      
      // Update selection
      selectedElement = targetIndex;
    }
    
    function onLayerDragEnd(e) {
      e.target.classList.remove('dragging');
      document.querySelectorAll('.layer-item').forEach(item => item.classList.remove('drag-over'));
      draggingLayerIndex = null;
    }
    
    // Toggle layer visibility
    function toggleLayerVisibility(e, index) {
      e.stopPropagation();
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      layout.elements[index].hidden = !layout.elements[index].hidden;
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    // Toggle layer lock
    function toggleLayerLock(e, index) {
      e.stopPropagation();
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      layout.elements[index].locked = !layout.elements[index].locked;
      saveToHistory();
      renderLayers(layout);
      
      // Deselect if we locked the current selection
      if (layout.elements[index].locked && selectedElement === index) {
        selectedElement = null;
        renderCanvas(layout);
      }
    }
    
    // Rename layer
    function startRenameLayer(e, index) {
      e.stopPropagation();
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      const nameSpan = e.target;
      const currentName = layout.elements[index].name || layout.elements[index].type;
      
      nameSpan.outerHTML = `<input type="text" class="layer-name-input" value="${currentName}" 
        onblur="finishRenameLayer(event, ${index})" 
        onkeydown="if(event.key==='Enter')finishRenameLayer(event,${index});if(event.key==='Escape')renderLayers(layouts.find(l=>l.id===activeLayoutId));"
        onclick="event.stopPropagation()">`;
      
      const input = document.querySelector('.layer-name-input');
      input.focus();
      input.select();
    }
    
    function finishRenameLayer(e, index) {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      const newName = e.target.value.trim();
      if (newName) {
        layout.elements[index].name = newName;
        saveToHistory();
      }
      renderLayers(layout);
    }
    
    // Duplicate element
    function duplicateElement(e, index) {
      e.stopPropagation();
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      const original = layout.elements[index];
      const duplicate = JSON.parse(JSON.stringify(original));
      duplicate.x += 20;
      duplicate.y += 20;
      duplicate.name = (duplicate.name || duplicate.type) + ' Copy';
      
      layout.elements.push(duplicate);
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      selectElement(layout.elements.length - 1);
    }
    
    // Delete from layer panel
    function deleteLayerElement(e, index) {
      e.stopPropagation();
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      if (confirm('Delete this element?')) {
        layout.elements.splice(index, 1);
        if (selectedElement === index) selectedElement = null;
        else if (selectedElement > index) selectedElement--;
        
        saveToHistory();
        renderCanvas(layout);
        renderLayers(layout);
        showPropertyPanel(null);
      }
    }
    
    function getElementIcon(type) {
      switch (type) {
        case 'text': return 'T';
        case 'image': return 'üñº';
        case 'rectangle': return '‚ñ¢';
        case 'circle': return '‚óã';
        case 'group': return 'üì¶';
        case 'menu_item': return 'üçî';
        case 'menu_section': return 'üìã';
        case 'price_list': return 'üí∞';
        case 'combo': return '‚≠ê';
        case 'category_header': return 'üè∑Ô∏è';
        case 'ticker': return 'üìú';
        default: return '?';
      }
    }
    
    // Add element
    function addElement(type) {
      if (!activeLayoutId) {
        alert('Please select or create a screen first');
        return;
      }
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      
      const newElement = {
        type,
        x: res.w / 2 - 100,
        y: res.h / 2 - 50,
        width: 200,
        height: 100,
        name: type.charAt(0).toUpperCase() + type.slice(1)
      };
      
      switch (type) {
        case 'text':
          newElement.content = 'New Text';
          newElement.fontSize = 48;
          newElement.color = '#ffffff';
          break;
        case 'image':
          newElement.src = '';
          newElement.width = 300;
          newElement.height = 200;
          break;
        case 'rectangle':
          newElement.color = '#333333';
          newElement.borderRadius = 0;
          break;
        case 'circle':
          newElement.color = '#333333';
          newElement.width = 150;
          newElement.height = 150;
          break;
        case 'group':
          newElement.width = 400;
          newElement.height = 300;
          newElement.color = 'rgba(0, 212, 255, 0.1)';
          newElement.borderColor = 'rgba(0, 212, 255, 0.3)';
          newElement.children = [];
          break;
      }
      
      if (!layout.elements) layout.elements = [];
      layout.elements.push(newElement);
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      
      // Select new element
      selectElement(layout.elements.length - 1);
    }

    // Add menu-aware element
    function addMenuElement(type) {
      if (!activeLayoutId) {
        alert('Please select or create a screen first');
        return;
      }
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      const defaults = MENU_ELEMENT_DEFAULTS[type];
      
      if (!defaults) {
        console.error('Unknown menu element type:', type);
        return;
      }
      
      const newElement = {
        type,
        x: res.w / 2 - defaults.width / 2,
        y: res.h / 2 - defaults.height / 2,
        width: defaults.width,
        height: defaults.height,
        name: type.replace('_', ' ').replace(/\b\w/g, l => l.toUpperCase()),
        data: JSON.parse(JSON.stringify(defaults.data)),
        style: JSON.parse(JSON.stringify(defaults.style))
      };
      
      if (!layout.elements) layout.elements = [];
      layout.elements.push(newElement);
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      
      // Select new element
      selectElement(layout.elements.length - 1);
    }
    
    // Select element
    function selectElement(index) {
      selectedElement = index;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements || !layout.elements[index]) return;
      
      const element = layout.elements[index];
      
      // Hide all property panels first
      hideAllPropertyPanels();
      
      // Show appropriate panel based on element type
      const menuTypes = ['menu_item', 'menu_section', 'price_list', 'combo', 'category_header', 'ticker'];
      
      if (menuTypes.includes(element.type)) {
        showMenuElementProperties(element);
      } else {
        // Show standard element properties
        document.getElementById('elementProperties').style.display = 'block';
        
        document.getElementById('elemX').value = Math.round(element.x);
        document.getElementById('elemY').value = Math.round(element.y);
        document.getElementById('elemW').value = Math.round(element.width);
        document.getElementById('elemH').value = Math.round(element.height);
        
        // Show type-specific properties
        const textRow = document.getElementById('textContentRow');
        const fontRow = document.getElementById('fontSizeRow');
        
        if (element.type === 'text') {
          textRow.style.display = 'flex';
          fontRow.style.display = 'flex';
          document.getElementById('elemText').value = element.content || '';
          document.getElementById('elemFontSize').value = element.fontSize || 24;
        } else {
          textRow.style.display = 'none';
          fontRow.style.display = 'none';
        }
        
        document.getElementById('elemColor').value = element.color || '#ffffff';
      }
      
      renderCanvas(layout);
      renderLayers(layout);
    }

    // Hide all property panels
    function hideAllPropertyPanels() {
      document.getElementById('screenProperties').style.display = 'none';
      document.getElementById('elementProperties').style.display = 'none';
      document.getElementById('menuItemProps').style.display = 'none';
      document.getElementById('menuSectionProps').style.display = 'none';
      document.getElementById('priceListProps').style.display = 'none';
      document.getElementById('comboProps').style.display = 'none';
      document.getElementById('categoryProps').style.display = 'none';
      document.getElementById('tickerProps').style.display = 'none';
    }
    
    // Alias for convenience
    const hideAllMenuProps = hideAllPropertyPanels;

    // Show menu element properties
    function showMenuElementProperties(element) {
      const data = element.data || {};
      const style = element.style || {};
      
      switch (element.type) {
        case 'menu_item':
          document.getElementById('menuItemProps').style.display = 'block';
          document.getElementById('menuItemName').value = data.name || '';
          document.getElementById('menuItemDesc').value = data.description || '';
          document.getElementById('menuItemPrice').value = data.price || '';
          document.getElementById('menuItemImage').value = data.image || '';
          document.getElementById('menuItemFontSize').value = style.fontSize || 24;
          document.getElementById('menuItemImageFit').value = style.imageFit || 'cover';
          document.getElementById('menuItemOpacity').value = style.opacity !== undefined ? style.opacity : 100;
          document.getElementById('menuItemOpacityValue').textContent = (style.opacity !== undefined ? style.opacity : 100) + '%';
          const showImageToggle = document.getElementById('menuItemShowImage');
          showImageToggle.classList.toggle('active', data.showImage !== false);
          const lockAspectToggle = document.getElementById('menuItemLockAspect');
          lockAspectToggle.classList.toggle('active', style.lockAspect !== false);
          
          // Show image preview if image exists
          const preview = document.getElementById('menuItemImagePreview');
          const thumb = document.getElementById('menuItemImageThumb');
          if (data.image && data.image.trim()) {
            thumb.src = data.image;
            preview.style.display = 'block';
          } else {
            preview.style.display = 'none';
          }
          break;
          
        case 'menu_section':
          document.getElementById('menuSectionProps').style.display = 'block';
          document.getElementById('sectionTitle').value = data.title || '';
          document.getElementById('sectionFontSize').value = style.fontSize || 36;
          document.getElementById('sectionColor').value = style.color || '#ffffff';
          const dividerToggle = document.getElementById('sectionShowDivider');
          dividerToggle.classList.toggle('active', data.showDivider !== false);
          break;
          
        case 'price_list':
          document.getElementById('priceListProps').style.display = 'block';
          const items = data.items || [];
          document.getElementById('priceListItems').value = items.map(i => `${i.name} | ${i.price}`).join('\n');
          document.getElementById('priceListFontSize').value = style.fontSize || 18;
          break;
          
        case 'combo':
          document.getElementById('comboProps').style.display = 'block';
          document.getElementById('comboTitle').value = data.title || '';
          document.getElementById('comboBadge').value = data.badge || '';
          document.getElementById('comboItems').value = data.items || '';
          document.getElementById('comboPrice').value = data.price || '';
          document.getElementById('comboBgColor').value = style.bgColor || '#7c3aed';
          break;
          
        case 'category_header':
          document.getElementById('categoryProps').style.display = 'block';
          document.getElementById('categoryTitle').value = data.title || '';
          document.getElementById('categorySubtitle').value = data.subtitle || '';
          document.getElementById('categoryIcon').value = data.icon || '';
          document.getElementById('categoryFontSize').value = style.fontSize || 42;
          break;
          
        case 'ticker':
          document.getElementById('tickerProps').style.display = 'block';
          const messages = data.messages || [];
          document.getElementById('tickerMessages').value = messages.join('\n');
          document.getElementById('tickerSpeed').value = data.speed || 20;
          document.getElementById('tickerBgColor').value = style.bgColor || '#000000';
          document.getElementById('tickerTextColor').value = style.textColor || '#ffffff';
          break;
      }
    }

    // Update functions for menu elements
    function updateMenuItemData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      element.data.name = document.getElementById('menuItemName').value;
      element.data.description = document.getElementById('menuItemDesc').value;
      element.data.price = document.getElementById('menuItemPrice').value;
      element.data.image = document.getElementById('menuItemImage').value;
      element.style.fontSize = parseInt(document.getElementById('menuItemFontSize').value) || 24;
      
      // Image fit and opacity controls
      element.style.imageFit = document.getElementById('menuItemImageFit').value;
      element.style.opacity = parseInt(document.getElementById('menuItemOpacity').value) || 100;
      document.getElementById('menuItemOpacityValue').textContent = element.style.opacity + '%';
      
      // Update image preview
      const imageUrl = element.data.image;
      const preview = document.getElementById('menuItemImagePreview');
      const thumb = document.getElementById('menuItemImageThumb');
      if (imageUrl && imageUrl.trim()) {
        thumb.src = imageUrl;
        preview.style.display = 'block';
      } else {
        preview.style.display = 'none';
      }
      
      saveToHistory();
      renderCanvas(layout);
    }
    
    // Toggle lock aspect ratio for images
    function toggleLockAspect() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.style) element.style = {};
      
      element.style.lockAspect = !element.style.lockAspect;
      document.getElementById('menuItemLockAspect').classList.toggle('active', element.style.lockAspect);
    }
    
    // Browse stock food images
    function browseStockImages() {
      const foodImages = [
        { name: 'Burger', url: 'https://images.unsplash.com/photo-1568901346375-23c9450c58cd?w=200&h=200&fit=crop' },
        { name: 'Pizza', url: 'https://images.unsplash.com/photo-1565299624946-b28f40a0ae38?w=200&h=200&fit=crop' },
        { name: 'Salad', url: 'https://images.unsplash.com/photo-1512621776951-a57141f2eefd?w=200&h=200&fit=crop' },
        { name: 'Steak', url: 'https://images.unsplash.com/photo-1600891964092-4316c288032e?w=200&h=200&fit=crop' },
        { name: 'Pasta', url: 'https://images.unsplash.com/photo-1563379926898-05f4575a45d8?w=200&h=200&fit=crop' },
        { name: 'Sushi', url: 'https://images.unsplash.com/photo-1579871494447-9811cf80d66c?w=200&h=200&fit=crop' },
        { name: 'Tacos', url: 'https://images.unsplash.com/photo-1565299585323-38d6b0865b47?w=200&h=200&fit=crop' },
        { name: 'Sandwich', url: 'https://images.unsplash.com/photo-1528735602780-2552fd46c7af?w=200&h=200&fit=crop' },
        { name: 'Chicken', url: 'https://images.unsplash.com/photo-1598103442097-8b74394b95c6?w=200&h=200&fit=crop' },
        { name: 'Fries', url: 'https://images.unsplash.com/photo-1573080496219-bb080dd4f877?w=200&h=200&fit=crop' },
        { name: 'Soup', url: 'https://images.unsplash.com/photo-1547592166-23ac45744acd?w=200&h=200&fit=crop' },
        { name: 'Dessert', url: 'https://images.unsplash.com/photo-1551024601-bec78aea704b?w=200&h=200&fit=crop' }
      ];
      
      const modal = document.createElement('div');
      modal.className = 'modal-overlay show';
      modal.id = 'stockImageModal';
      modal.innerHTML = `
        <div class="modal" style="max-width: 500px;">
          <div class="modal-header">
            <h3 class="modal-title">Select Food Image</h3>
            <button class="modal-close" onclick="closeStockImageModal()">√ó</button>
          </div>
          <div class="modal-body">
            <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px;">
              ${foodImages.map(img => `
                <div onclick="selectStockImage('${img.url}')" style="cursor: pointer; border-radius: 8px; overflow: hidden; border: 2px solid transparent; transition: border-color 0.2s;" onmouseover="this.style.borderColor='var(--accent)'" onmouseout="this.style.borderColor='transparent'">
                  <img src="${img.url}" alt="${img.name}" style="width: 100%; height: 80px; object-fit: cover; display: block;">
                  <div style="font-size: 10px; text-align: center; padding: 4px; background: var(--bg-card);">${img.name}</div>
                </div>
              `).join('')}
            </div>
            <p style="margin-top: 12px; font-size: 11px; color: var(--text-muted);">Or paste any image URL in the field above</p>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
    }
    
    function selectStockImage(url) {
      document.getElementById('menuItemImage').value = url;
      updateMenuItemData();
      closeStockImageModal();
    }
    
    function closeStockImageModal() {
      const modal = document.getElementById('stockImageModal');
      if (modal) modal.remove();
    }

    function toggleMenuItemImage() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      
      element.data.showImage = !element.data.showImage;
      document.getElementById('menuItemShowImage').classList.toggle('active', element.data.showImage);
      
      saveToHistory();
      renderCanvas(layout);
    }

    function updateSectionData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      element.data.title = document.getElementById('sectionTitle').value;
      element.style.fontSize = parseInt(document.getElementById('sectionFontSize').value) || 36;
      element.style.color = document.getElementById('sectionColor').value;
      
      saveToHistory();
      renderCanvas(layout);
    }

    function toggleSectionDivider() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      
      element.data.showDivider = !element.data.showDivider;
      document.getElementById('sectionShowDivider').classList.toggle('active', element.data.showDivider);
      
      saveToHistory();
      renderCanvas(layout);
    }

    function updatePriceListData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      const text = document.getElementById('priceListItems').value;
      element.data.items = text.split('\n').filter(line => line.trim()).map(line => {
        const parts = line.split('|').map(s => s.trim());
        return { name: parts[0] || '', price: parts[1] || '' };
      });
      element.style.fontSize = parseInt(document.getElementById('priceListFontSize').value) || 18;
      
      renderCanvas(layout);
    }

    function updateComboData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      element.data.title = document.getElementById('comboTitle').value;
      element.data.badge = document.getElementById('comboBadge').value;
      element.data.items = document.getElementById('comboItems').value;
      element.data.price = document.getElementById('comboPrice').value;
      element.style.bgColor = document.getElementById('comboBgColor').value;
      
      renderCanvas(layout);
    }

    function updateCategoryData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      element.data.title = document.getElementById('categoryTitle').value;
      element.data.subtitle = document.getElementById('categorySubtitle').value;
      element.data.icon = document.getElementById('categoryIcon').value;
      element.style.fontSize = parseInt(document.getElementById('categoryFontSize').value) || 42;
      
      renderCanvas(layout);
    }

    function updateTickerData() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const element = layout.elements[selectedElement];
      if (!element.data) element.data = {};
      if (!element.style) element.style = {};
      
      const text = document.getElementById('tickerMessages').value;
      element.data.messages = text.split('\n').filter(line => line.trim());
      element.data.speed = parseInt(document.getElementById('tickerSpeed').value) || 20;
      element.style.bgColor = document.getElementById('tickerBgColor').value;
      element.style.textColor = document.getElementById('tickerTextColor').value;
      
      renderCanvas(layout);
    }

    // Auto-layout alignment helper
    function alignElement(alignment) {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      const element = layout.elements[selectedElement];
      const safeZone = SAFE_ZONES[layout.safe_zone || 'standard'] || 48;
      
      switch (alignment) {
        case 'left':
          element.x = safeZone;
          break;
        case 'center':
          element.x = (res.w - element.width) / 2;
          break;
        case 'right':
          element.x = res.w - element.width - safeZone;
          break;
      }
      
      renderCanvas(layout);
    }

    // Template functions
    function showTemplateModal() {
      if (!activeLayoutId) {
        alert('Please select or create a screen first');
        return;
      }
      document.getElementById('templateModal').classList.add('show');
      selectedTemplate = null;
      document.querySelectorAll('.template-card').forEach(el => el.classList.remove('selected'));
    }

    function hideTemplateModal() {
      document.getElementById('templateModal').classList.remove('show');
    }

    function selectTemplate(templateKey) {
      selectedTemplate = templateKey;
      document.querySelectorAll('.template-card').forEach(el => {
        el.classList.toggle('selected', el.dataset.template === templateKey);
      });
    }

    function insertTemplate() {
      if (!selectedTemplate || !activeLayoutId) return;
      
      const template = TEMPLATES[selectedTemplate];
      if (!template) return;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      // Confirm if layout has existing elements
      if (layout.elements && layout.elements.length > 0) {
        if (!confirm('This will add template elements to your existing layout. Continue?')) {
          return;
        }
      }
      
      if (!layout.elements) layout.elements = [];
      
      // Add template elements with deep copy
      template.elements.forEach(el => {
        layout.elements.push(JSON.parse(JSON.stringify(el)));
      });
      
      hideTemplateModal();
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    // Drag handling
    function startDrag(event, index) {
      // Don't start drag if clicking on resize handle
      if (event.target.classList.contains('resize-handle')) return;
      
      event.preventDefault();
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      const element = layout.elements[index];
      
      // Don't allow dragging locked elements
      if (element.locked) {
        showToast('Element is locked', 'warning');
        return;
      }
      
      selectedElement = index;
      isDragging = true;
      
      // Get the canvas container position (accounts for wrapper transform)
      const canvasRect = document.getElementById('canvasContainer').getBoundingClientRect();
      
      // Calculate mouse position in unscaled canvas coordinates
      const mouseX = (event.clientX - canvasRect.left) / zoom;
      const mouseY = (event.clientY - canvasRect.top) / zoom;
      
      // Calculate offset from element's current position
      dragOffset.x = mouseX - element.x;
      dragOffset.y = mouseY - element.y;
      
      selectElement(index);
      
      document.addEventListener('mousemove', onDrag);
      document.addEventListener('mouseup', stopDrag);
    }
    
    function onDrag(event) {
      if (!isDragging || selectedElement === null) return;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      // Get canvas container bounding rect (already scaled by CSS transform)
      const canvasRect = document.getElementById('canvasContainer').getBoundingClientRect();
      
      // Calculate mouse position in unscaled canvas coordinates
      const mouseX = (event.clientX - canvasRect.left) / zoom;
      const mouseY = (event.clientY - canvasRect.top) / zoom;
      
      // Apply the offset to get the element's new position
      const x = mouseX - dragOffset.x;
      const y = mouseY - dragOffset.y;
      
      layout.elements[selectedElement].x = Math.max(0, x);
      layout.elements[selectedElement].y = Math.max(0, y);
      
      renderCanvas(layout);
      
      // Update property inputs
      document.getElementById('elemX').value = Math.round(x);
      document.getElementById('elemY').value = Math.round(y);
    }
    
    function stopDrag() {
      if (isDragging) {
        saveToHistory();
      }
      isDragging = false;
      document.removeEventListener('mousemove', onDrag);
      document.removeEventListener('mouseup', stopDrag);
    }
    
    // Resize handling
    let isResizing = false;
    let resizeDirection = null;
    let resizeStart = { x: 0, y: 0, width: 0, height: 0, elemX: 0, elemY: 0 };
    
    function startResize(event, index, direction) {
      event.preventDefault();
      event.stopPropagation();
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      const element = layout.elements[index];
      
      // Don't allow resizing locked elements
      if (element.locked) {
        showToast('Element is locked', 'warning');
        return;
      }
      
      isResizing = true;
      resizeDirection = direction;
      selectedElement = index;
      
      const canvasRect = document.getElementById('canvasContainer').getBoundingClientRect();
      
      resizeStart = {
        x: (event.clientX - canvasRect.left) / zoom,
        y: (event.clientY - canvasRect.top) / zoom,
        width: element.width,
        height: element.height,
        elemX: element.x,
        elemY: element.y
      };
      
      selectElement(index);
      
      document.addEventListener('mousemove', onResize);
      document.addEventListener('mouseup', stopResize);
    }
    
    function onResize(event) {
      if (!isResizing || selectedElement === null) return;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const canvasRect = document.getElementById('canvasContainer').getBoundingClientRect();
      const mouseX = (event.clientX - canvasRect.left) / zoom;
      const mouseY = (event.clientY - canvasRect.top) / zoom;
      
      const deltaX = mouseX - resizeStart.x;
      const deltaY = mouseY - resizeStart.y;
      
      const element = layout.elements[selectedElement];
      const minSize = 20;
      
      // Handle different resize directions
      switch (resizeDirection) {
        case 'e':
          element.width = Math.max(minSize, resizeStart.width + deltaX);
          break;
        case 'w':
          const newWidthW = resizeStart.width - deltaX;
          if (newWidthW >= minSize) {
            element.width = newWidthW;
            element.x = resizeStart.elemX + deltaX;
          }
          break;
        case 's':
          element.height = Math.max(minSize, resizeStart.height + deltaY);
          break;
        case 'n':
          const newHeightN = resizeStart.height - deltaY;
          if (newHeightN >= minSize) {
            element.height = newHeightN;
            element.y = resizeStart.elemY + deltaY;
          }
          break;
        case 'se':
          element.width = Math.max(minSize, resizeStart.width + deltaX);
          element.height = Math.max(minSize, resizeStart.height + deltaY);
          break;
        case 'sw':
          const newWidthSW = resizeStart.width - deltaX;
          if (newWidthSW >= minSize) {
            element.width = newWidthSW;
            element.x = resizeStart.elemX + deltaX;
          }
          element.height = Math.max(minSize, resizeStart.height + deltaY);
          break;
        case 'ne':
          element.width = Math.max(minSize, resizeStart.width + deltaX);
          const newHeightNE = resizeStart.height - deltaY;
          if (newHeightNE >= minSize) {
            element.height = newHeightNE;
            element.y = resizeStart.elemY + deltaY;
          }
          break;
        case 'nw':
          const newWidthNW = resizeStart.width - deltaX;
          const newHeightNW = resizeStart.height - deltaY;
          if (newWidthNW >= minSize) {
            element.width = newWidthNW;
            element.x = resizeStart.elemX + deltaX;
          }
          if (newHeightNW >= minSize) {
            element.height = newHeightNW;
            element.y = resizeStart.elemY + deltaY;
          }
          break;
      }
      
      renderCanvas(layout);
      
      // Update property inputs
      document.getElementById('elemX').value = Math.round(element.x);
      document.getElementById('elemY').value = Math.round(element.y);
      document.getElementById('elemW').value = Math.round(element.width);
      document.getElementById('elemH').value = Math.round(element.height);
    }
    
    function stopResize() {
      if (isResizing) {
        saveToHistory();
      }
      isResizing = false;
      resizeDirection = null;
      document.removeEventListener('mousemove', onResize);
      document.removeEventListener('mouseup', stopResize);
    }
    
    // Update functions
    function updateElementPosition() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      layout.elements[selectedElement].x = parseInt(document.getElementById('elemX').value) || 0;
      layout.elements[selectedElement].y = parseInt(document.getElementById('elemY').value) || 0;
      saveToHistory();
      renderCanvas(layout);
    }
    
    function updateElementSize() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      layout.elements[selectedElement].width = parseInt(document.getElementById('elemW').value) || 100;
      layout.elements[selectedElement].height = parseInt(document.getElementById('elemH').value) || 100;
      saveToHistory();
      renderCanvas(layout);
    }
    
    function updateElementContent() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      layout.elements[selectedElement].content = document.getElementById('elemText').value;
      renderCanvas(layout);
    }
    
    function updateElementStyle() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      layout.elements[selectedElement].color = document.getElementById('elemColor').value;
      if (layout.elements[selectedElement].type === 'text') {
        layout.elements[selectedElement].fontSize = parseInt(document.getElementById('elemFontSize').value) || 24;
      }
      renderCanvas(layout);
    }
    
    function deleteSelectedElement() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      layout.elements.splice(selectedElement, 1);
      selectedElement = null;
      
      saveToHistory();
      document.getElementById('elementProperties').style.display = 'none';
      document.getElementById('screenProperties').style.display = 'block';
      hideAllMenuProps();
      
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    // Property Tab Switching
    function switchPropertyTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.property-tab').forEach(tab => tab.classList.remove('active'));
      document.querySelector(`.property-tab[onclick*="${tabName}"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.property-tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(`propTab${tabName.charAt(0).toUpperCase() + tabName.slice(1)}`).classList.add('active');
    }
    
    // Duplicate selected element
    function duplicateSelectedElement() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      const original = layout.elements[selectedElement];
      const duplicate = JSON.parse(JSON.stringify(original));
      duplicate.x += 20;
      duplicate.y += 20;
      duplicate.name = (duplicate.name || duplicate.type) + ' Copy';
      
      layout.elements.push(duplicate);
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      selectElement(layout.elements.length - 1);
    }
    
    // Z-order functions
    function bringToFront() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      const [element] = layout.elements.splice(selectedElement, 1);
      layout.elements.push(element);
      selectedElement = layout.elements.length - 1;
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    function sendToBack() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      const [element] = layout.elements.splice(selectedElement, 1);
      layout.elements.unshift(element);
      selectedElement = 0;
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    // Lock/hide from property panel
    function lockElement() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      layout.elements[selectedElement].locked = !layout.elements[selectedElement].locked;
      const isLocked = layout.elements[selectedElement].locked;
      document.getElementById('lockElementBtn').innerHTML = isLocked ? 'üîí Unlock' : 'üîì Lock';
      
      saveToHistory();
      renderLayers(layout);
      if (isLocked) {
        selectedElement = null;
        renderCanvas(layout);
      }
    }
    
    function hideElement() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      layout.elements[selectedElement].hidden = !layout.elements[selectedElement].hidden;
      const isHidden = layout.elements[selectedElement].hidden;
      document.getElementById('hideElementBtn').innerHTML = isHidden ? 'üëÅ‚Äçüó® Show' : 'üëÅ Hide';
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
    }
    
    // Element Grouping
    function groupSelectedElements() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      // For now, create a new group element at current selection position
      if (selectedElement === null) {
        showToast('Select an element first', 'warning');
        return;
      }
      
      const element = layout.elements[selectedElement];
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      
      // Create group containing the selected element
      const group = {
        type: 'group',
        name: 'Group',
        x: element.x - 10,
        y: element.y - 10,
        width: element.width + 20,
        height: element.height + 20,
        children: [] // Store child element indices
      };
      
      // Mark the element as child of this group
      element.parentId = layout.elements.length; // Index of the new group
      group.children.push(selectedElement);
      
      layout.elements.push(group);
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      selectElement(layout.elements.length - 1);
      showToast('Group created', 'success');
    }
    
    function ungroupElement() {
      if (selectedElement === null) return;
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout || !layout.elements[selectedElement]) return;
      
      const element = layout.elements[selectedElement];
      if (element.type !== 'group') {
        showToast('Select a group to ungroup', 'warning');
        return;
      }
      
      // Remove parent references from children
      if (element.children) {
        element.children.forEach(childIdx => {
          if (layout.elements[childIdx]) {
            delete layout.elements[childIdx].parentId;
          }
        });
      }
      
      // Remove the group element
      layout.elements.splice(selectedElement, 1);
      selectedElement = null;
      
      saveToHistory();
      renderCanvas(layout);
      renderLayers(layout);
      showToast('Ungrouped', 'success');
    }
    
    // Screen property updates
    function updateScreenName() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      layout.name = document.getElementById('screenNameInput').value;
      renderScreensList();
    }
    
    function updateResolution() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      layout.resolution = document.getElementById('resolutionSelect').value;
      renderCanvas(layout);
      renderScreensList();
    }
    
    function updateSafeZone() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      layout.safe_zone = document.getElementById('safeZoneSelect').value;
      renderCanvas(layout);
    }
    
    function updateBackground() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      layout.background_color = document.getElementById('bgColorInput').value;
      layout.background_image = document.getElementById('bgImageInput').value;
      renderCanvas(layout);
      renderScreensList();
    }
    
    // Screen drag and drop for reordering
    let draggedScreenIndex = null;
    
    function onScreenDragStart(event) {
      const card = event.target.closest('.screen-card');
      draggedScreenIndex = parseInt(card.dataset.index);
      card.classList.add('dragging');
      event.dataTransfer.effectAllowed = 'move';
    }
    
    function onScreenDragOver(event) {
      event.preventDefault();
      const card = event.target.closest('.screen-card');
      if (card) {
        document.querySelectorAll('.screen-card').forEach(c => c.classList.remove('drag-over'));
        card.classList.add('drag-over');
      }
    }
    
    function onScreenDrop(event) {
      event.preventDefault();
      const card = event.target.closest('.screen-card');
      if (!card || draggedScreenIndex === null) return;
      
      const targetIndex = parseInt(card.dataset.index);
      if (draggedScreenIndex === targetIndex) return;
      
      // Reorder layouts array
      const [movedLayout] = layouts.splice(draggedScreenIndex, 1);
      layouts.splice(targetIndex, 0, movedLayout);
      
      // Re-render
      renderScreensList();
      console.log('Screens reordered - remember to save');
    }
    
    function onScreenDragEnd(event) {
      document.querySelectorAll('.screen-card').forEach(c => {
        c.classList.remove('dragging', 'drag-over');
      });
      draggedScreenIndex = null;
    }
    
    // Delete screen
    async function deleteScreen(layoutId) {
      if (!confirm('Are you sure you want to delete this screen? This cannot be undone.')) {
        return;
      }
      
      try {
        await apiRequest(`/layouts/${layoutId}`, { method: 'DELETE' });
        
        // Remove from local array
        layouts = layouts.filter(l => l.id !== layoutId);
        
        // If we deleted the active one, switch to another or show empty state
        if (activeLayoutId === layoutId) {
          if (layouts.length > 0) {
            selectLayout(layouts[0].id);
          } else {
            activeLayoutId = null;
            document.getElementById('noScreensMessage').style.display = 'flex';
            document.getElementById('canvasWrapper').style.display = 'none';
            document.getElementById('canvasInfo').style.display = 'none';
          }
        }
        
        renderScreensList();
      } catch (error) {
        alert('Error deleting screen: ' + error.message);
      }
    }
    
    // Zoom controls
    function zoomIn() {
      zoom = Math.min(zoom + 0.1, 2);
      applyZoom();
    }
    
    function zoomOut() {
      zoom = Math.max(zoom - 0.1, 0.1);
      applyZoom();
    }
    
    function zoomFit() {
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      const res = RESOLUTIONS[layout.resolution] || { w: 1920, h: 1080 };
      const canvasArea = document.getElementById('canvasArea');
      const padding = 80;
      
      const availableWidth = canvasArea.clientWidth - padding;
      const availableHeight = canvasArea.clientHeight - padding;
      
      const scaleX = availableWidth / res.w;
      const scaleY = availableHeight / res.h;
      
      zoom = Math.min(scaleX, scaleY, 1);
      applyZoom();
    }
    
    function applyZoom() {
      const wrapper = document.getElementById('canvasWrapper');
      wrapper.style.transform = `scale(${zoom})`;
      document.getElementById('zoomValue').textContent = Math.round(zoom * 100) + '%';
    }
    
    // Populate resolution select
    function populateResolutionSelect() {
      const select = document.getElementById('resolutionSelect');
      select.innerHTML = Object.entries(RESOLUTIONS).map(([key, val]) => 
        `<option value="${key}">${val.label} (${val.w}√ó${val.h})</option>`
      ).join('');
    }
    
    // Populate resolution grid in modal
    function populateResolutionGrid() {
      const grid = document.getElementById('resolutionGrid');
      grid.innerHTML = Object.entries(RESOLUTIONS).map(([key, val]) => `
        <div class="resolution-option" data-resolution="${key}" onclick="selectResolutionOption('${key}')">
          <div class="resolution-option-name">${val.label}</div>
          <div class="resolution-option-size">${val.w} √ó ${val.h}</div>
        </div>
      `).join('');
    }
    
    let selectedResolutionOption = '1080p';
    
    function selectResolutionOption(key) {
      selectedResolutionOption = key;
      document.querySelectorAll('.resolution-option').forEach(el => {
        el.classList.toggle('selected', el.dataset.resolution === key);
      });
    }
    
    // Modal functions
    function showAddScreenModal() {
      document.getElementById('addScreenModal').classList.add('show');
      document.getElementById('newScreenName').value = '';
      selectResolutionOption('1080p');
    }
    
    function hideAddScreenModal() {
      document.getElementById('addScreenModal').classList.remove('show');
    }
    
    // Create new screen (layout)
    async function createScreen() {
      const name = document.getElementById('newScreenName').value || 'New Screen';
      const resolution = selectedResolutionOption;
      
      try {
        const result = await apiRequest('/layouts', {
          method: 'POST',
          body: JSON.stringify({
            menuId: currentMenu.id,
            name,
            resolution,
            safe_zone: 'standard',
            background_color: '#000000',
            elements: []
          })
        });
        
        layouts.push(result.layout);
        hideAddScreenModal();
        selectLayout(result.layout.id);
        
      } catch (error) {
        alert('Error creating screen: ' + error.message);
      }
    }
    
    // Save layout
    async function saveLayout() {
      if (!activeLayoutId) return;
      
      const layout = layouts.find(l => l.id === activeLayoutId);
      if (!layout) return;
      
      try {
        await apiRequest(`/layouts/${layout.id}`, {
          method: 'PUT',
          body: JSON.stringify({
            name: layout.name,
            resolution: layout.resolution,
            safe_zone: layout.safe_zone,
            background_color: layout.background_color,
            background_image: layout.background_image,
            elements: layout.elements
          })
        });
        
        alert('Layout saved!');
      } catch (error) {
        alert('Error saving layout: ' + error.message);
      }
    }
    
    // Publish menu
    async function publishMenu() {
      if (!currentMenu) return;
      
      // First save current layout
      if (activeLayoutId) {
        await saveLayout();
      }
      
      try {
        await apiRequest(`/menus/${currentMenu.id}/publish`, {
          method: 'POST'
        });
        
        // Update status
        currentMenu.status = 'published';
        document.getElementById('menuStatus').textContent = 'published';
        document.getElementById('menuStatus').className = 'menu-status published';
        
        alert('Menu published successfully!');
      } catch (error) {
        alert('Error publishing: ' + error.message);
      }
    }
    
    // Show no screens message
    function showNoScreensMessage() {
      document.getElementById('noScreensMessage').style.display = 'flex';
      document.getElementById('canvasWrapper').style.display = 'none';
      document.getElementById('canvasInfo').style.display = 'none';
    }
    
    // Setup canvas interactions
    function setupCanvasInteractions() {
      const canvasArea = document.getElementById('canvasArea');
      
      // Click on canvas to deselect
      canvasArea.addEventListener('click', (e) => {
        if (e.target === canvasArea || e.target.id === 'canvasWrapper' || e.target.id === 'canvasContainer') {
          selectedElement = null;
          hideAllPropertyPanels();
          document.getElementById('screenProperties').style.display = 'block';
          
          const layout = layouts.find(l => l.id === activeLayoutId);
          if (layout) {
            renderCanvas(layout);
            renderLayers(layout);
          }
        }
      });
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Delete' || e.key === 'Backspace') {
          if (selectedElement !== null && document.activeElement.tagName !== 'INPUT') {
            deleteSelectedElement();
          }
        }
        
        if (e.key === 's' && (e.metaKey || e.ctrlKey)) {
          e.preventDefault();
          saveLayout();
        }
      });
    }
    
    // Initialize on load
    init();
  </script>
</body>
</html>
